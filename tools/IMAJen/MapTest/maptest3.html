<!DOCTYPE html><html><head><meta charset=utf8><title>FPSLite</title><meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel=stylesheet><style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:'Courier New',Courier,monospace}
#gameCanvas{display:block;width:100vw;height:100vh;background:#111;cursor:none}
.info{position:absolute;top:10px;left:10px;padding:10px 15px;background:#000b;border-radius:8px;z-index:1000;line-height:1.6;font-size:14px;pointer-events:none}
.info strong{display:block;margin-bottom:5px;font-size:16px}
.info div{margin-bottom:5px}
#loadingOverlay,#gameOverOverlay{position:absolute;top:0;left:0;right:0;bottom:0;color:#fff;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:2000;font-family:'Press Start 2P','Courier New',Courier,monospace;text-align:center}
#loadingOverlay.hide{display:none}
#gameOverOverlay{background:#000e;color:#f00;display:none;z-index:3000;cursor:default;padding:20px;box-sizing:border-box}
#gameOverOverlay h1{font-size:calc(24px + 4vw);line-height:1.2;margin-bottom:25px;color:#f00;text-shadow:4px 4px #000;text-transform:uppercase;letter-spacing:3px;word-spacing:10px}
#gameOverOverlay p{font-size:calc(14px + 1vw);color:#fff;margin-bottom:40px;text-shadow:2px 2px #333;line-height:1.5}
#restartButton{padding:15px 30px;font-size:calc(12px + .8vw);color:#fff;background:#555;border:4px outset #aaa;cursor:pointer;font-family:'Press Start 2P','Courier New',Courier,monospace;text-transform:uppercase;transition:none;box-shadow:3px 3px 0 #222;letter-spacing:1px}
#restartButton:hover{background:#666;border-color:#bbb;box-shadow:4px 4px #111;transform:translate(-1px,-1px);color:#ff0}
#restartButton:active{background:#444;border-style:inset;border-color:#888;box-shadow:none;transform:translate(3px,3px);color:#fff}
.joystick-container{position:absolute;bottom:20px;width:120px;height:120px;border-radius:50%;background:#fff2;touch-action:none;user-select:none;z-index:1001;display:none;box-shadow:0 0 10px #0006} #movementJoystick{left:30px}
.joystick-knob{position:absolute;width:60px;height:60px;left:30px;top:30px;border-radius:50%;background:#fff6;transform:translate(0,0);pointer-events:none;transition:transform .1s}
body.mobile #movementJoystick{display:block}
#fireButton,#jumpButton{position:absolute;right:30px;width:90px;height:50px;border-radius:8px;color:#fff;font-size:16px;display:none;align-items:center;justify-content:center;cursor:pointer;user-select:none;-webkit-user-select:none;touch-action:manipulation;z-index:1001;box-shadow:0 0 8px #0006;padding:5px;box-sizing:border-box}
#fireButton{bottom:100px;background:#f336;border:2px solid #f339}
#jumpButton{bottom:40px;background:#fff4;border:2px solid #fff6}
body.mobile #jumpButton,body.mobile #fireButton{display:flex}
#jumpButton:active{background:#fff6}
#fireButton:active{background:#f339}
#hud{position:absolute;top:10px;right:10px;background:#0008;padding:8px 12px;border-radius:5px;color:#fff;font-size:14px;text-align:right;z-index:1000;display:none;pointer-events:none}
#hud-hp-label{display:flex;justify-content:flex-end;align-items:center;margin-bottom:2px}
#hud-hp-value{margin-left:5px;min-width:30px;text-align:left}
#hud-hp-bar-bg{width:100px;height:12px;background:#555;border:1px solid #888;margin-bottom:4px}
#hud-hp-bar{height:100%;background:#0f0;width:100%;transition:width .2s ease-out,background .2s ease-out}
#hud-ammo{display:flex;justify-content:flex-end;align-items:center;margin-top:4px;height:16px}
#hud-ammo-value{margin-right:5px;min-width:30px;text-align:left}
#hud-ammo-icons{display:flex;align-items:center}
#hud-ammo-icons img{width:10px;height:16px;margin-left:2px;image-rendering:pixelated;object-fit:contain;transition:opacity .2s} #hud-ammo-icons img.empty{opacity:.3}
#hud-score{margin-top:4px}
.info .mobile-controls{display:none} .info .desktop-controls{display:block} body.mobile .info .mobile-controls{display:block} body.mobile .info .desktop-controls{display:none}
@media (max-width:600px){#gameOverOverlay h1{font-size:calc(20px + 5vw);letter-spacing:2px;word-spacing:5px;text-shadow:3px 3px #000} #gameOverOverlay p{font-size:calc(12px + 1.5vw)} #restartButton{font-size:calc(10px + 1vw);padding:12px 25px;border-width:3px} .info{font-size:12px;padding:8px 10px} .info strong{font-size:14px}}
</style></head><body><canvas id=gameCanvas></canvas><div class=info><div class=desktop-controls><div><strong>Controls (Desktop):</strong></div><div>Move: W/A/S/D</div><div>Jump: Space</div><div>Shoot: L Click</div><div>Look: Mouse (Lock)</div></div><div class=mobile-controls><div><strong>Controls (Mobile):</strong></div><div>Move: L Joy</div><div>Shoot: Top R Btn</div><div>Jump: Btm R Btn</div><div>Look: Drag</div></div></div><div id=loadingOverlay><h1>Loading...</h1><p id=loadingText></div><div id=gameOverOverlay><h1>GAME OVER</h1><p>Final Score: <span id=finalScore>0</span><button id=restartButton>RESTART</button></div><div id=movementJoystick class=joystick-container><div class=joystick-knob id=movementKnob></div></div><button id=fireButton>FIRE</button><button id=jumpButton>JUMP</button><div id=hud><div id=hud-hp-label>HP:<span id=hud-hp-value>100</span></div><div id=hud-hp-bar-bg><div id=hud-hp-bar></div></div><div id=hud-ammo><span id=hud-ammo-value>50</span><div id=hud-ammo-icons></div></div><div id=hud-score>Score: 0</div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js></script><script src=https://unpkg.com/three@0.128.0/examples/js/controls/PointerLockControls.js></script><script src=https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js></script><script src=https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js></script><script src=https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js></script><script src=https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js></script><script>
let RENDER_WIDTH=320,RENDER_HEIGHT=200,USE_POSTPROCESSING=!0,MAP_WIDTH=24,MAP_HEIGHT=24,CELL_SIZE=1,WALL_HEIGHT=1,MOVE_SPEED=3,MOUSE_SENSITIVITY=.002,TOUCH_SENSITIVITY=.006,PLAYER_EYE_HEIGHT=0,PLAYER_RADIUS=.25,GRAVITY=9.8,JUMP_FORCE=4,DOOR_MARKER=99,SLIDING_DOOR_MARKER=6,BORDER_CONCRETE_MARKER=7,DOOR_SPEED=1.5,DOOR_TRIGGER_DISTANCE=2,DOOR_FULLY_OPEN_OFFSET=WALL_HEIGHT*.98,DOOR_SLIDE_DISTANCE=CELL_SIZE*.5,PLAYER_MAX_HP=100,PLAYER_DAMAGE=25,PLAYER_MAX_AMMO=50,AMMO_PACK_VALUE=20,BULLETS_PER_INDICATOR=10,MAX_AMMO_INDICATORS=5,PISTOL_FIRE_RATE=4,PISTOL_FIRE_FRAMES=19,PISTOL_FIRE_FRAME_WIDTH=350,PISTOL_FIRE_FRAME_HEIGHT=200,PISTOL_FIRE_FRAME_DURATION=.05,PISTOL_FIRING_ANIMATION_DURATION=PISTOL_FIRE_FRAME_DURATION*PISTOL_FIRE_FRAMES,BIGGUN_FIRE_RATE=5,BIGGUN_FIRE_FRAMES=14,BIGGUN_FIRE_FRAME_WIDTH=350,BIGGUN_FIRE_FRAME_HEIGHT=200,BIGGUN_FIRE_FRAME_DURATION=.045,BIGGUN_FIRING_ANIMATION_DURATION=BIGGUN_FIRE_FRAME_DURATION*BIGGUN_FIRE_FRAMES,BIGGUN_DAMAGE=35,HEALTH_PACK_VALUE=50,SCORE_PER_KILL=100,ITEM_PICKUP_RADIUS_SQ=.3*.3,BULLETHOLE_LIFETIME=30,BULLETHOLE_SIZE=.08,ITEM_SCALE_DEFAULT=.6,ITEM_SCALE_AMMO=.35,ITEM_SCALE_BIGGUN=1.5,BLOOD_SPLATTER_LIFETIME=25,BLOOD_SPLATTER_SIZE=.7,ENEMY_HEALTH=250,ENEMY_DAMAGE=10,ENEMY_ATTACK_RANGE_SQ=4,ENEMY_SIGHT_RANGE_SQ=144,ENEMY_ATTACK_COOLDOWN=1.5,ENEMY_MOVE_SPEED=1.5,ENEMY_RADIUS=.3,ENEMY_IDLE_FRAMES=5,ENEMY_IDLE_FRAME_DURATION=.625/ENEMY_IDLE_FRAMES,ENEMY_ATTACK_FRAMES=10,ENEMY_ATTACK_FRAME_DURATION=1.25/ENEMY_ATTACK_FRAMES,ENEMY_ATTACK_DAMAGE_FRAME=5,ENEMY_DEATH_DURATION=.5,ENEMY_SCALE=.9,MAX_CRATE_STACK_HEIGHT=3,CRATE_SIZE=CELL_SIZE*.8;
let manualCratePositions=[{gridX:8,gridY:5,stackHeight:1},{gridX:11,gridY:3,stackHeight:1},{gridX:15,gridY:2,stackHeight:1},{gridX:11,gridY:13,stackHeight:1},{gridX:15,gridY:16,stackHeight:1}];
let assetManifest={'w_b1':'images/BRICK_1A.png','w_t1':'images/TECH_1C.PNG','w_m1':'images/STEEL_1A.PNG','w_w1':'images/WOOD_1C.png','w_b3b':'images/BRICK_3B.png','w_bd_l':'images/Bigdoor_left.png','w_bd_r':'images/Bigdoor_right.png','w_tr':'images/trim2.png','f_m':'images/FLOOR_4A.png','c_g':'images/GRID_1A.png','d_v':'images/vdoor.png','i_h':'images/health_pack.png','i_a':'images/ammo.png','e_i':'images/enemy_idle.png','e_a':'images/enemy_attack.png','bh':'images/bullethole.png','hud_b':'images/bullet.png','bl':'images/blood.png','bl1':'images/blood1.png','p_i':'images/gun.gif','p_f':'images/fire.png','bg_i':'images/biggun1.png','bg_f':'images/biggun.png','i_bg':'images/biggunitem.png','cr1':'images/crate1.png','cr2':'images/crate2.png','cr3':'images/crate3.png','cr4':'images/crate4.png','kcr':'images/keycardreader.png','w_c':'images/concretewall.png', 'sky':'images/sky.png'}; // Added 'sky' entry
let wallTextureKeys={1:'w_b1',2:'w_t1',3:'w_m1',4:'w_w1',5:'w_b3b',[SLIDING_DOOR_MARKER]:'w_bd_l',[BORDER_CONCRETE_MARKER]:'w_c'};
let floorTextureKey='f_m',ceilingTextureKey='c_g',doorTextureKey='d_v',crateTextureKeys=['cr1','cr2','cr3','cr4'];
let weapons={'pistol':{idleAssetKey:'p_i',fireAssetKey:'p_f',fireFrames:PISTOL_FIRE_FRAMES,frameWidth:PISTOL_FIRE_FRAME_WIDTH,frameHeight:PISTOL_FIRE_FRAME_HEIGHT,frameDuration:PISTOL_FIRE_FRAME_DURATION,animationDuration:PISTOL_FIRING_ANIMATION_DURATION,fireRate:PISTOL_FIRE_RATE,damage:PLAYER_DAMAGE,idleMaterial:null,firingMaterial:null,geometry:null},'biggun':{idleAssetKey:'bg_i',fireAssetKey:'bg_f',fireFrames:BIGGUN_FIRE_FRAMES,frameWidth:BIGGUN_FIRE_FRAME_WIDTH,frameHeight:BIGGUN_FIRE_FRAME_HEIGHT,frameDuration:BIGGUN_FIRE_FRAME_DURATION,animationDuration:BIGGUN_FIRING_ANIMATION_DURATION,fireRate:BIGGUN_FIRE_RATE,damage:BIGGUN_DAMAGE,idleMaterial:null,firingMaterial:null,geometry:null}};
let md=[],dd=[],dm=[],dMap=[],as={},wm={},fm,cm,dmt,scn,cam,rend,ctrls,clk,cmp,rt,mvF=!1,mvB=!1,stL=!1,stR=!1,jmpR=!1,shtR=!1,isPL=!1,mvJoy=null,lkTId=null,lstLkX=0,pV=0,isG=!0,lm,tl,lo,lt,jbe,fbe,php=PLAYER_MAX_HP,pam=PLAYER_MAX_AMMO,scr=0,sprs=[],so={},enms=[],isFA=!1,fAT=0,fCF=0,fFT=0,tSLS=1/weapons['pistol'].fireRate,he,hle,hve,hbe,hse,hae,have,haie,gMsh,cg,rc,bht,abh=[],abs=[],gr=!1,goe,fse,rbe,cwk='pistol',pHasBG=!1,pSGX,pSGY,cMtls=[],cG,cGrp,cPos=[],dfm,dfmsh=[],krm,sdm=[];
let isMobile=('ontouchstart'in window||navigator.maxTouchPoints>0);
let dir=new THREE.Vector3(),tmpV3=new THREE.Vector3(),enMV=new THREE.Vector3(),splBP=new THREE.Vector3();
let TFS=THREE.FrontSide,TNF=THREE.NearestFilter,TRW=THREE.RepeatWrapping,TDS=THREE.DoubleSide,PI=Math.PI, TBS=THREE.BackSide; // Added TBS
let GE=a=>document.getElementById(a);
let initialSceneData=[{mapX:2.5,mapZ:2.5,textureKey:'i_h',type:'item_health',value:HEALTH_PACK_VALUE},{mapX:5.5,mapZ:5.5,textureKey:'i_h',type:'item_health',value:HEALTH_PACK_VALUE},{mapX:13.5,mapZ:9.5,textureKey:'i_h',type:'item_health',value:HEALTH_PACK_VALUE},{mapX:12.5,mapZ:2.5,textureKey:'i_a',type:'item_ammo',value:AMMO_PACK_VALUE},{mapX:15.5,mapZ:4.5,textureKey:'i_bg',type:'item_biggun',value:AMMO_PACK_VALUE},{mapX:11.5,mapZ:15.5,textureKey:'i_a',type:'item_ammo',value:AMMO_PACK_VALUE},{mapX:4.5,mapZ:4.5,type:'enemy',health:ENEMY_HEALTH},{mapX:10.5,mapZ:6.5,type:'enemy',health:ENEMY_HEALTH},{mapX:14.5,mapZ:14.5,type:'enemy',health:ENEMY_HEALTH}];
let mapOffsetX=MAP_WIDTH*CELL_SIZE/2,mapOffsetZ=MAP_HEIGHT*CELL_SIZE/2;
initialSceneData.forEach(sp=>{sp.worldX=sp.mapX*CELL_SIZE-mapOffsetX;sp.worldZ=sp.mapZ*CELL_SIZE-mapOffsetZ;sp.id=`${sp.type}_${sp.mapX}_${sp.mapZ}`});
function iG(){lo=GE("loadingOverlay");lt=GE("loadingText");jbe=GE('jumpButton');fbe=GE('fireButton');he=GE('hud');hle=GE('hud-hp-label');hve=GE('hud-hp-value');hbe=GE('hud-hp-bar');hse=GE('hud-score');hae=GE('hud-ammo');have=GE('hud-ammo-value');haie=GE('hud-ammo-icons');goe=GE('gameOverOverlay');fse=GE('finalScore');rbe=GE('restartButton');lt.textContent="Initializing...";clk=new THREE.Clock();i3();iL();generateMap();lA().then(()=>{cM();cWMG();cMg();aDF();aKR();cCG();cGrp=new THREE.Group();scn.add(cGrp);sPS();aMC();sSO();sVM();uH();he&&(he.style.display='block');sIL();rbe.addEventListener('click',rG);lo?.classList.add("hide");gr=!0;anim();}).catch(e=>{console.error("Load/Setup failed:",e);lt.textContent="Error loading assets. Check console.";});}
function i3(){scn=new THREE.Scene();scn.background=new THREE.Color(0x111111);cam=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,100);cam.position.y=PLAYER_EYE_HEIGHT;rend=new THREE.WebGLRenderer({canvas:GE('gameCanvas')});rend.setPixelRatio(window.devicePixelRatio);rend.setSize(window.innerWidth,window.innerHeight);if(USE_POSTPROCESSING){rt=new THREE.WebGLRenderTarget(RENDER_WIDTH,RENDER_HEIGHT,{minFilter:TNF,magFilter:TNF,format:THREE.RGBFormat,stencilBuffer:false});cmp=new THREE.EffectComposer(rend,rt);let rp=new THREE.RenderPass(scn,cam);cmp.addPass(rp);let cp=new THREE.ShaderPass(THREE.CopyShader);cmp.addPass(cp);}ctrls=new THREE.PointerLockControls(cam,rend.domElement);ctrls.pointerSpeed=MOUSE_SENSITIVITY/.002;ctrls.addEventListener('lock',()=>{if(gr){isPL=!0;document.body.style.cursor='none';}else{ctrls.unlock();}});ctrls.addEventListener('unlock',()=>{isPL=!1;document.body.style.cursor='default';});scn.add(ctrls.getObject());window.addEventListener('resize',oWR,!1);rc=new THREE.Raycaster();}
function iL(){lm=new THREE.LoadingManager(()=>{},(url,loaded,total)=>lt.textContent=`Loading: ${url} (${loaded}/${total})`,(url)=>console.error('Error loading asset:',url));tl=new THREE.TextureLoader(lm);}
function lA(){let p=[];for(let k in assetManifest){p.push(new Promise((res,rej)=>{tl.load(assetManifest[k],t=>{t.magFilter=TNF;t.minFilter=TNF;t.generateMipmaps=!1;as[k]=t;res();},null,e=>{console.error(`Failed to load ${k} from ${assetManifest[k]}:`,e);lt.textContent=`Error loading ${k}. Check path/console.`;rej(e);});}));}return Promise.all(p);}
function generateMap(){md=Array.from({length:MAP_HEIGHT},()=>Array(MAP_WIDTH).fill(0));dd=[];dMap=Array.from({length:MAP_HEIGHT},()=>Array(MAP_WIDTH).fill(null));function dR(x,y,w,h,wi){for(let i=x;i<x+w;i++){if(i>=0&&i<MAP_WIDTH){if(y>=0&&y<MAP_HEIGHT)md[y][i]=wi;if(y+h-1>=0&&y+h-1<MAP_HEIGHT)md[y+h-1][i]=wi;}}for(let j=y+1;j<y+h-1;j++){if(j>=0&&j<MAP_HEIGHT){if(x>=0&&x<MAP_WIDTH)md[j][x]=wi;if(x+w-1>=0&&x<MAP_WIDTH)md[j][x+w-1]=wi;}}}function fI(x,y,w,h,fi=0){for(let j=y+1;j<y+h-1;j++){for(let i=x+1;i<x+w-1;i++){if(i>=0&&i<MAP_WIDTH&&j>=0&&j<MAP_HEIGHT)md[j][i]=fi;}}}function pD(x,y){if(x>=0&&x<MAP_WIDTH&&y>=0&&y<MAP_HEIGHT)md[y][x]=DOOR_MARKER;}dR(1,1,6,6,1);fI(1,1,6,6,0);dR(6,3,5,3,3);fI(6,3,5,3,0);dR(10,1,7,7,2);fI(10,1,7,7,0);dR(12,7,3,6,3);fI(12,7,3,6,0);dR(10,12,7,7,4);fI(10,12,7,7,0);md[4][1]=SLIDING_DOOR_MARKER;md[3][1]=5;md[5][1]=5;pD(6,4);pD(10,4);pD(13,7);pD(13,12);for(let i=0;i<MAP_WIDTH;i++){if(md[0][i]===0)md[0][i]=BORDER_CONCRETE_MARKER;if(md[MAP_HEIGHT-1][i]===0)md[MAP_HEIGHT-1][i]=BORDER_CONCRETE_MARKER;}for(let j=0;j<MAP_HEIGHT;j++){if(md[j][0]===0)md[j][0]=BORDER_CONCRETE_MARKER;if(md[j][MAP_WIDTH-1]===0)md[j][MAP_WIDTH-1]=BORDER_CONCRETE_MARKER;}md[4][0] = 0;}
function cM(){let c={side:TFS};wm={};for(let t in wallTextureKeys){let k=wallTextureKeys[t];wm[t]=as[k]?new THREE.MeshBasicMaterial({map:as[k],...c}):new THREE.MeshBasicMaterial({color:0xcccccc,...c});}if(as[floorTextureKey]){let t=as[floorTextureKey];t.wrapS=t.wrapT=TRW;t.repeat.set(MAP_WIDTH,MAP_HEIGHT);fm=new THREE.MeshBasicMaterial({map:t,...c});}else{fm=new THREE.MeshBasicMaterial({color:0x444444,...c});}if(as[ceilingTextureKey]){let t=as[ceilingTextureKey];t.wrapS=t.wrapT=TRW;t.repeat.set(MAP_WIDTH,MAP_HEIGHT);cm=new THREE.MeshBasicMaterial({map:t,...c});}else{cm=new THREE.MeshBasicMaterial({color:0x666666,...c});}dmt=as[doorTextureKey]?new THREE.MeshBasicMaterial({map:as[doorTextureKey],...c}):new THREE.MeshBasicMaterial({color:0x888888,...c});bht=as['bh'];if(!bht)console.warn("Bullethole texture not found!");cMtls=[];for(let key of crateTextureKeys){if(as[key]){cMtls.push(new THREE.MeshBasicMaterial({map:as[key],...c}));}else{console.warn(`Crate texture not found: ${key}. Using default.`);let colors=[0x8B4513,0xA0522D,0xCD853F,0xD2691E];cMtls.push(new THREE.MeshBasicMaterial({color:colors[cMtls.length%colors.length],...c}));}}if(cMtls.length===0){console.error("No crate textures loaded or defined!");cMtls.push(new THREE.MeshBasicMaterial({color:0x966F33,...c}));}if(as['w_tr']){dfm=new THREE.MeshBasicMaterial({map:as['w_tr'],side:TFS});}else{console.warn("Door frame texture not found! Using fallback.");dfm=new THREE.MeshBasicMaterial({color:0x555555,side:TFS});}if(as['kcr']){krm=new THREE.MeshBasicMaterial({map:as['kcr'],side:TFS});}else{console.warn("Keycard reader texture not found! Using fallback.");krm=new THREE.MeshBasicMaterial({color:0xcccccc,side:TFS});}}
function cCG(){cG?.dispose();cG=new THREE.BoxGeometry(CRATE_SIZE,CRATE_SIZE,CRATE_SIZE);}
function cWMG(){for(let key in weapons){let w=weapons[key];let iT=as[w.idleAssetKey];let fT=as[w.fireAssetKey];if(!iT||!fT){console.error(`Assets not loaded for weapon: ${key}`);continue;}w.idleMaterial=new THREE.MeshBasicMaterial({map:iT.clone(),transparent:!0,depthTest:!1,side:TDS});w.idleMaterial.map.needsUpdate=!0;let fTC=fT.clone();fTC.needsUpdate=!0;fTC.repeat.set(1/w.fireFrames,1);w.firingMaterial=new THREE.MeshBasicMaterial({map:fTC,transparent:!0,depthTest:!1,side:TDS});let gA=w.frameWidth/w.frameHeight,gVH=.42,gVW=gVH*gA;w.geometry=new THREE.PlaneGeometry(gVW,gVH);}}
function cMg(){let wg=new THREE.BoxGeometry(CELL_SIZE,WALL_HEIGHT,CELL_SIZE);dd=[];dMap=Array.from({length:MAP_HEIGHT},()=>Array(MAP_WIDTH).fill(null));dm=[];for(let y=0;y<MAP_HEIGHT;y++){for(let x=0;x<MAP_WIDTH;x++){let ct=md[y]?.[x];if(ct>0&&ct!=DOOR_MARKER&&ct!=SLIDING_DOOR_MARKER){let m=wm[ct]||wm[1];let wM=new THREE.Mesh(wg,m);wM.position.set((x+.5)*CELL_SIZE-mapOffsetX,0,(y+.5)*CELL_SIZE-mapOffsetZ);scn.add(wM);}else if(ct==SLIDING_DOOR_MARKER){let texLeft=as['w_bd_l'];let texRight=as['w_bd_r'];if(!texLeft||!texRight){console.error(`Sliding door textures w_bd_l or w_bd_r not found!`);continue;}const commonMatProps={map:null,side:TFS};let matLeftFront=new THREE.MeshBasicMaterial({...commonMatProps,map:texRight});let matRightFront=new THREE.MeshBasicMaterial({...commonMatProps,map:texLeft});let matLeftBack=new THREE.MeshBasicMaterial({...commonMatProps,map:texLeft});let matRightBack=new THREE.MeshBasicMaterial({...commonMatProps,map:texRight});let pW=CELL_SIZE/2;let pH=WALL_HEIGHT;let pG=new THREE.PlaneGeometry(pW,pH);let cX=(x+.5)*CELL_SIZE-mapOffsetX;let cZ=(y+.5)*CELL_SIZE-mapOffsetZ;let baseLeftZ=cZ-pW/2;let baseRightZ=cZ+pW/2;let thicknessOffset=0.01;let meshLeftFront=new THREE.Mesh(pG,matLeftFront);meshLeftFront.rotation.y=PI/2;meshLeftFront.position.set(cX+thicknessOffset/2,0,baseLeftZ);let meshLeftBack=new THREE.Mesh(pG,matLeftBack);meshLeftBack.rotation.y=-PI/2;meshLeftBack.position.set(cX-thicknessOffset/2,0,baseLeftZ);let meshRightFront=new THREE.Mesh(pG,matRightFront);meshRightFront.rotation.y=PI/2;meshRightFront.position.set(cX+thicknessOffset/2,0,baseRightZ);let meshRightBack=new THREE.Mesh(pG,matRightBack);meshRightBack.rotation.y=-PI/2;meshRightBack.position.set(cX-thicknessOffset/2,0,baseRightZ);scn.add(meshLeftFront);scn.add(meshLeftBack);scn.add(meshRightFront);scn.add(meshRightBack);let nd={x,y,worldX:cX,worldZ:cZ,state:'closed',offset:0,type:'sliding',meshLeftFront:meshLeftFront,meshLeftBack:meshLeftBack,meshRightFront:meshRightFront,meshRightBack:meshRightBack,originalLeftZ:baseLeftZ,originalRightZ:baseRightZ};dd.push(nd);dMap[y][x]=nd;}else if(ct==DOOR_MARKER){let dt=CELL_SIZE*.1;let gEW=new THREE.BoxGeometry(CELL_SIZE,WALL_HEIGHT,dt);let gNS=new THREE.BoxGeometry(dt,WALL_HEIGHT,CELL_SIZE);let iN=!1;let lC=(x>0&&md[y]!=null)?md[y][x-1]:0;let rC=(x<MAP_WIDTH-1&&md[y]!=null)?md[y][x+1]:0;if((lC>0&&lC!=DOOR_MARKER&&lC!=SLIDING_DOOR_MARKER)||(rC>0&&rC!=DOOR_MARKER&&rC!=SLIDING_DOOR_MARKER))iN=!0;let dMesh=new THREE.Mesh(iN?gEW:gNS,dmt);let wX=(x+.5)*CELL_SIZE-mapOffsetX,wZ=(y+.5)*CELL_SIZE-mapOffsetZ;dMesh.position.set(wX,0,wZ);scn.add(dMesh);dm.push(dMesh);let nd={x,y,worldX:wX,worldZ:wZ,state:'closed',offset:0,type:'vertical',meshIndex:dm.length-1};dd.push(nd);dMap[y][x]=nd;}}}let fg=new THREE.PlaneGeometry(MAP_WIDTH*CELL_SIZE,MAP_HEIGHT*CELL_SIZE);let fMesh=new THREE.Mesh(fg,fm);fMesh.rotation.x=-PI/2;fMesh.position.y=-WALL_HEIGHT/2;scn.add(fMesh);let cgGeo=new THREE.PlaneGeometry(MAP_WIDTH*CELL_SIZE,MAP_HEIGHT*CELL_SIZE);let cMesh=new THREE.Mesh(cgGeo,cm);cMesh.rotation.x=PI/2;cMesh.position.y=WALL_HEIGHT/2;scn.add(cMesh);
    if (as['sky']) {
        let skyGeo = new THREE.SphereGeometry(50, 32, 16);
        let skyMat = new THREE.MeshBasicMaterial({
            map: as['sky'],
            side: TBS
        });
        let skybox = new THREE.Mesh(skyGeo, skyMat);
        scn.add(skybox);
    } else {
        console.warn("Sky texture 'sky.png' not loaded, cannot create skybox.");
    }
}
function aDF(){if(!dfm){console.error("Cannot add door frame: Material not ready.");return;}let ftgx=1,ftgy=4,tw=CELL_SIZE*.125,td=.02;let wcx=(ftgx+.5)*CELL_SIZE-mapOffsetX,wcz=(ftgy+.5)*CELL_SIZE-mapOffsetZ;let ffx=wcx+CELL_SIZE/2;let tg=new THREE.BoxGeometry(td,tw,CELL_SIZE);let tm=new THREE.Mesh(tg,dfm);tm.position.set(ffx+td/2,WALL_HEIGHT/2-tw/2,wcz);scn.add(tm);dfmsh.push(tm);let sg=new THREE.BoxGeometry(td,WALL_HEIGHT,tw);let uvs=sg.attributes.uv.array;uvs[8]=0;uvs[9]=0;uvs[10]=0;uvs[11]=1;uvs[12]=1;uvs[13]=1;uvs[14]=1;uvs[15]=0;uvs[20]=0;uvs[21]=0;uvs[18]=0;uvs[19]=1;uvs[16]=1;uvs[17]=1;uvs[22]=1;uvs[23]=0;sg.attributes.uv.needsUpdate=!0;let lsg=sg.clone();let lm=new THREE.Mesh(lsg,dfm.clone());lm.position.set(ffx+td/2,0,wcz-CELL_SIZE/2+tw/2);scn.add(lm);dfmsh.push(lm);let rm=new THREE.Mesh(sg,dfm.clone());rm.position.set(ffx+td/2,0,wcz+CELL_SIZE/2-tw/2);scn.add(rm);dfmsh.push(rm);}
function aKR(){if(!krm){console.error("Cannot add keycard reader: Material not ready.");return;}let rw=.1,rh=.15,rd=.02;let krg=new THREE.BoxGeometry(rw,rh,rd);let krmesh1=new THREE.Mesh(krg,krm);let tgx1=1,tgy1=5;let wcx1=(tgx1+.5)*CELL_SIZE-mapOffsetX,wcz1=(tgy1+.5)*CELL_SIZE-mapOffsetZ;let wfz1=wcz1-CELL_SIZE/2;let rxo1=-CELL_SIZE*.4,ryo1=0;krmesh1.position.set(wcx1+rxo1,ryo1,wfz1-rd/2);krmesh1.rotation.y=0;scn.add(krmesh1);sdm.push(krmesh1);let krmesh2=new THREE.Mesh(krg,krm.clone());let tgx2=2,tgy2=4;let wcx2=(tgx2)*CELL_SIZE-mapOffsetX;let wcz2_offset = 1.2; let wcz2=(tgy2 + wcz2_offset)*CELL_SIZE-mapOffsetZ;let rxo2=rd/2,ryo2=0;krmesh2.position.set(wcx2+rxo2,ryo2,wcz2);krmesh2.rotation.y=-PI/2;scn.add(krmesh2);sdm.push(krmesh2);}
function gCT(x,y){if(x<0||x>=MAP_WIDTH||y<0||y>=MAP_HEIGHT)return -1;return md[y]?.[x]??-1;}
function aMC(){if(!cG||cMtls.length===0||!cGrp){console.error("Cannot add crates: Geometry, materials, or group not ready.");return;}let gy=-WALL_HEIGHT/2,cbo=CRATE_SIZE/2;for(let cd of manualCratePositions){let gx=cd.gridX,gyG=cd.gridY;let sh=Math.max(1,Math.min(MAX_CRATE_STACK_HEIGHT,cd.stackHeight||1));if(gCT(gx,gyG)!==0){console.warn(`Skipping manual crate @ (${gx},${gyG}): Cell not empty.`);continue;}if(cPos.some(p=>p.gridX===gx&&p.gridY===gyG)){console.warn(`Skipping manual crate @ (${gx},${gyG}): Crate already exists.`);continue;}let wx=(gx+.5)*CELL_SIZE-mapOffsetX,wz=(gyG+.5)*CELL_SIZE-mapOffsetZ;let sty=gy+cbo+(sh-1)*CRATE_SIZE;
    if (sty + CRATE_SIZE / 2 >= WALL_HEIGHT / 2) {
        console.warn(`Skipping/reducing manual crate @ (${gx},${gyG}): Stack too tall.`);
        continue;
    }
    cPos.push({gridX:gx,gridY:gyG});for(let h=0;h<sh;h++){let cy=gy+cbo+h*CRATE_SIZE;let rm=cMtls[((Math.random()*cMtls.length)|0)];let cMesh=new THREE.Mesh(cG,rm);cMesh.position.set(wx,cy,wz);cMesh.rotation.y=Math.random()*PI*.1-PI*.05;cGrp.add(cMesh);}}}
function sPS(){let sx=3.5,sz=3.5;pSGX=sx|0;pSGY=sz|0;ctrls.getObject().position.set(sx*CELL_SIZE-mapOffsetX,PLAYER_EYE_HEIGHT,sz*CELL_SIZE-mapOffsetZ);ctrls.getObject().rotation.set(0,0,0);isG=!0;pV=0;php=PLAYER_MAX_HP;pam=PLAYER_MAX_AMMO;scr=0;pHasBG=!1;sW('pistol');gr=!0;if(!isMobile){document.body.style.cursor='default';if(isPL)document.exitPointerLock(),isPL=!1;}else{document.body.style.cursor='none';}}
function dM(mesh){if(!mesh)return;scn.remove(mesh);mesh.geometry?.dispose();if(mesh.material){if(Array.isArray(mesh.material))mesh.material.forEach(m=>{m.map?.dispose();m.dispose();});else{mesh.material.map?.dispose();mesh.material.dispose();}}}
function cSO(){sprs.forEach(s=>{if(s&&s.object3D){dM(s.object3D);if(s.idleMaterial){s.idleMaterial.map?.dispose();s.idleMaterial.dispose();}if(s.attackMaterial){s.attackMaterial.map?.dispose();s.attackMaterial.dispose();}}});sprs=[];so={};enms=[];abh.forEach(h=>{if(h&&h.mesh)dM(h.mesh);});abh=[];abs.forEach(s=>{if(s&&s.mesh)dM(s.mesh);});abs=[];if(cGrp){while(cGrp.children.length>0){let child=cGrp.children[0];cGrp.remove(child);dM(child);}scn.remove(cGrp);}cGrp=new THREE.Group();scn.add(cGrp);cPos=[];dd.forEach(d=>{if(d.type=='sliding'){dM(d.meshLeftFront);dM(d.meshLeftBack);dM(d.meshRightFront);dM(d.meshRightBack);dM(d.meshLeft);dM(d.meshRight);} else if (d.type == 'vertical' && d.meshIndex >= 0 && d.meshIndex < dm.length) { /* Cleanup handled by dm loop */ } });dm.forEach(m=>dM(m));dm=[];dd=[];dMap=Array.from({length:MAP_HEIGHT},()=>Array(MAP_WIDTH).fill(null));dfmsh.forEach(m=>dM(m));dfmsh=[];sdm.forEach(m=>dM(m));sdm=[];}
function sSO(){initialSceneData.forEach(sd=>{let gx=sd.mapX|0,gy=sd.mapZ|0;if(cPos.some(p=>p.gridX===gx&&p.gridY===gy)){console.warn(`Skipping spawn at (${gx},${gy}) due to crate obstruction: ${sd.id}`);return;}let si=null,itemY=-WALL_HEIGHT/2+.3,groundY=-WALL_HEIGHT/2,enemyH=ENEMY_SCALE,enemyY=groundY+(enemyH/2);if(sd.type.startsWith('item_')){if(sd.type=='item_biggun'&&pHasBG)return;let tex=as[sd.textureKey];if(!tex){console.warn(`Texture ${sd.textureKey} not found for item ${sd.id}`);return;}let mat=new THREE.SpriteMaterial({map:tex.clone(),transparent:!0,depthTest:!0,depthWrite:!0,sizeAttenuation:!0});mat.map.needsUpdate=!0;let spr=new THREE.Sprite(mat);spr.position.set(sd.worldX,itemY,sd.worldZ);let scale=ITEM_SCALE_DEFAULT;if(sd.type=='item_ammo')scale=ITEM_SCALE_AMMO;else if(sd.type=='item_biggun')scale=ITEM_SCALE_BIGGUN;spr.scale.set(scale,scale,scale);si={id:sd.id,type:sd.type,value:sd.value||0,object3D:spr,isEnemy:!1};}else if(sd.type=='enemy'){let iTex=as['e_i']?.clone(),aTex=as['e_a']?.clone();if(!iTex||!aTex){console.error(`Enemy textures missing for ${sd.id}`);return;}iTex.needsUpdate=!0;iTex.repeat.set(1/ENEMY_IDLE_FRAMES,1);iTex.offset.x=0;let iMat=new THREE.SpriteMaterial({map:iTex,transparent:!0,depthTest:!0,depthWrite:!0,sizeAttenuation:!0});aTex.needsUpdate=!0;aTex.repeat.set(1/ENEMY_ATTACK_FRAMES,1);aTex.offset.x=0;let aMat=new THREE.SpriteMaterial({map:aTex,transparent:!0,depthTest:!0,depthWrite:!0,sizeAttenuation:!0});let wMat=iMat,spr=new THREE.Sprite(iMat);spr.position.set(sd.worldX,enemyY,sd.worldZ);spr.scale.set(ENEMY_SCALE,ENEMY_SCALE,ENEMY_SCALE);si={id:sd.id,type:sd.type,object3D:spr,health:ENEMY_HEALTH,maxHealth:ENEMY_HEALTH,state:'idle',radius:ENEMY_RADIUS,moveSpeed:ENEMY_MOVE_SPEED,idleMaterial:iMat,attackMaterial:aMat,walkMaterial:wMat,attackCooldown:Math.random()*ENEMY_ATTACK_COOLDOWN,animationTimer:0,currentFrame:0,lastFrameAction:-1,deathTimer:0,isEnemy:!0};enms.push(si);}if(si){sprs.push(si);so[si.id]=si;scn.add(si.object3D);}});}
function sVM(){gMsh&&cam.remove(gMsh);cg&&cam.remove(cg);let iW=weapons['pistol'];if(!iW||!iW.geometry||!iW.idleMaterial){console.error("Pistol data not ready for viewmodel.");return;}gMsh=new THREE.Mesh(iW.geometry,iW.idleMaterial);gMsh.position.set(0,-.09,-.45);cam.add(gMsh);cg=new THREE.Group();let cM=new THREE.MeshBasicMaterial({color:0x00ff00,transparent:!0,opacity:.7,depthTest:!1});let lL=.004,lT=.0008,lG=.0015,cZ=-.1;let hG=new THREE.PlaneGeometry(lL,lT),vG=new THREE.PlaneGeometry(lT,lL);let l=new THREE.Mesh(hG,cM),r=new THREE.Mesh(hG,cM),t=new THREE.Mesh(vG,cM),b=new THREE.Mesh(vG,cM);l.position.set(-lG-lL/2,0,cZ);r.position.set(lG+lL/2,0,cZ);t.position.set(0,lG+lL/2,cZ);b.position.set(0,-lG-lL/2,cZ);cg.add(l,r,t,b);cam.add(cg);sW('pistol');}
function sW(key){if(!weapons[key]||!gMsh){console.error(`Cannot switch to weapon: ${key}.`);return;}if(cwk===key&&gMsh.material==weapons[key].idleMaterial)return;let wD=weapons[key];if(gMsh.geometry!=wD.geometry){gMsh.geometry?.dispose();gMsh.geometry=wD.geometry;}gMsh.material=wD.idleMaterial;isFA=!1;fAT=0;fCF=0;fFT=0;tSLS=1/wD.fireRate;cwk=key;uH();}
function sIL(){document.addEventListener('keydown',e=>{if(!gr)return;switch(e.code){case 'KeyW':mvF=!0;break;case 'KeyA':stL=!0;break;case 'KeyS':mvB=!0;break;case 'KeyD':stR=!0;break;case 'Space':jmpR=!0;break;}});document.addEventListener('keyup',e=>{switch(e.code){case 'KeyW':mvF=!1;break;case 'KeyA':stL=!1;break;case 'KeyS':mvB=!1;break;case 'KeyD':stR=!1;break;case 'Space':jmpR=!1;break;}});rend.domElement.addEventListener('mousedown',e=>{if(e.button===0&&!isMobile){if(gr&&!isPL)ctrls.lock();else if(gr&&isPL)shtR=!0;}});rend.domElement.addEventListener('mouseup',e=>{if(e.button===0)shtR=!1;});rend.domElement.addEventListener('touchstart',hTS,!1);rend.domElement.addEventListener('touchmove',hTM,!1);rend.domElement.addEventListener('touchend',hTE,!1);rend.domElement.addEventListener('touchcancel',hTE,!1);function hTS(e){if(!isMobile||!gr)return;let onUI=!1,fR=fbe?.getBoundingClientRect(),jR=jbe?.getBoundingClientRect();for(let i=0;i<e.changedTouches.length;i++){let t=e.changedTouches[i];if(fbe&&fR&&t.clientX>=fR.left&&t.clientX<=fR.right&&t.clientY>=fR.top&&t.clientY<=fR.bottom){onUI=!0;break;}if(jbe&&jR&&t.clientX>=jR.left&&t.clientX<=jR.right&&t.clientY>=jR.top&&t.clientY<=jR.bottom){onUI=!0;break;}}if(!onUI){e.preventDefault();let t=e.changedTouches[0],joyR=mvJoy?.container.getBoundingClientRect(),isJoy=mvJoy&&joyR&&t.clientX>=joyR.left&&t.clientX<=joyR.right&&t.clientY>=joyR.top&&t.clientY<=joyR.bottom;if(!isJoy&&lkTId===null){lkTId=t.identifier;lstLkX=t.clientX;}}}function hTM(e){if(!isMobile||!gr)return;for(let i=0;i<e.changedTouches.length;i++){let t=e.changedTouches[i];if(t.identifier===lkTId){e.preventDefault();let dX=t.clientX-lstLkX;lstLkX=t.clientX;ctrls.getObject().rotation.y-=dX*TOUCH_SENSITIVITY;break;}}}function hTE(e){if(!isMobile||!gr)return;for(let i=0;i<e.changedTouches.length;i++){if(e.changedTouches[i].identifier===lkTId){lkTId=null;break;}}}if(isMobile){document.body.classList.add('mobile');let jC=GE('movementJoystick'),jK=GE('movementKnob');if(jC&&jK)mvJoy=new Joy(jC,jK);else console.error("Joystick missing");if(jbe){jbe.addEventListener('touchstart',e=>{if(!gr)return;e.preventDefault();jmpR=!0;},!1);jbe.addEventListener('touchend',e=>{if(!gr)return;e.preventDefault();jmpR=!1;},!1);}else console.error("Jump Btn missing");if(fbe){fbe.addEventListener('touchstart',e=>{if(!gr)return;e.preventDefault();shtR=!0;},!1);fbe.addEventListener('touchend',e=>{if(!gr)return;e.preventDefault();shtR=!1;},!1);}else console.error("Fire Btn missing");}else{document.body.classList.remove('mobile');}}
let animFrameId=null;
function anim(){if(!gr){animFrameId&&(cancelAnimationFrame(animFrameId),animFrameId=null);return;}animFrameId=requestAnimationFrame(anim);let dt=Math.min(.1,clk.getDelta()),cWD=weapons[cwk];uI(dt);uP(dt);uD(dt);cIP(dt);uE(dt);uEA(dt);uGA(dt,cWD);uBH(dt);uBS(dt);tSLS+=dt;if(shtR&&pam>0&&tSLS>=(1/cWD.fireRate)&&(isPL||isMobile))tS(cWD);else if(shtR&&pam<=0&&tSLS>=(1/cWD.fireRate))tSLS=0;cg&&(cg.visible=isPL||isMobile);USE_POSTPROCESSING&&cmp?cmp.render(dt):rend.render(scn,cam);}
function uI(dt){if(isMobile&&mvJoy){let t=.1;mvF=mvJoy.cY<-t;mvB=mvJoy.cY>t;stL=mvJoy.cX<-t;stR=mvJoy.cX>t;}(ctrls.isLocked||isMobile)&&(dir.z=+mvF - +mvB,dir.x=+stL - +stR,dir.lengthSq()>1&&dir.normalize(),(()=>{let speed=MOVE_SPEED*dt,mX=0,mZ=0;ctrls.getDirection(tmpV3);let fwd=tmpV3.setY(0).normalize(),rt=new THREE.Vector3();rt.crossVectors(ctrls.getObject().up,fwd).normalize();mZ+=fwd.z*dir.z*speed;mX+=fwd.x*dir.z*speed;mZ+=rt.z*dir.x*speed;mX+=rt.x*dir.x*speed;let cPos=ctrls.getObject().position,tX=cPos.x+mX,tZ=cPos.z+mZ;cMT(tX,cPos.z,PLAYER_RADIUS)&&(cPos.x=tX);cMT(cPos.x,tZ,PLAYER_RADIUS)&&(cPos.z=tZ);})());}
function uP(dt){let pO=ctrls.getObject();jmpR&&isG&&(pV=JUMP_FORCE,isG=!1,jmpR=!1);isG||(pV-=GRAVITY*dt);pO.position.y+=pV*dt;if(pO.position.y<PLAYER_EYE_HEIGHT){pO.position.y=PLAYER_EYE_HEIGHT;pV=0;isG=!0;}else isG=!1;let cY=WALL_HEIGHT/2;pO.position.y>cY-PLAYER_RADIUS&&(pO.position.y=cY-PLAYER_RADIUS,pV>0&&(pV=0));}
function uD(dt){let pP=ctrls.getObject().position;for(let i=0;i<dd.length;i++){let d=dd[i];if(!d)continue;let dc=(d.type=='vertical')?dm[d.meshIndex]?.position:(d.meshLeftFront?.position||d.meshLeft?.position);if(!dc)continue;let dx=pP.x-d.worldX,dz=pP.z-d.worldZ,dSq=dx*dx+dz*dz,tSq=DOOR_TRIGGER_DISTANCE*DOOR_TRIGGER_DISTANCE,target=dSq<tSq?'opening':'closing';target=='opening'&&(d.state=='closed'||d.state=='closing')?d.state='opening':target=='closing'&&(d.state=='open'||d.state=='opening')&&(d.state='closing');let changed=!1;if(d.state=='opening'){d.offset+=DOOR_SPEED*dt;if(d.offset>=DOOR_FULLY_OPEN_OFFSET)d.offset=DOOR_FULLY_OPEN_OFFSET,d.state='open';changed=!0;}else if(d.state=='closing'){d.offset-=DOOR_SPEED*dt;if(d.offset<=0)d.offset=0,d.state='closed';changed=!0;}if(changed){if(d.type=='vertical'&&d.meshIndex>=0&&d.meshIndex<dm.length)dm[d.meshIndex].position.y=d.offset;else if(d.type=='sliding'&&d.meshLeftFront){let slideAmount=(d.offset/DOOR_FULLY_OPEN_OFFSET)*DOOR_SLIDE_DISTANCE;d.meshLeftFront.position.z=d.originalLeftZ-slideAmount;d.meshLeftBack.position.z=d.originalLeftZ-slideAmount;d.meshRightFront.position.z=d.originalRightZ+slideAmount;d.meshRightBack.position.z=d.originalRightZ+slideAmount;} else if (d.type == 'sliding' && d.meshLeft && d.meshRight) {
                let slideAmount = (d.offset / DOOR_FULLY_OPEN_OFFSET) * DOOR_SLIDE_DISTANCE;
                d.meshLeft.position.z = d.originalLeftZ - slideAmount;
                d.meshRight.position.z = d.originalRightZ + slideAmount;
            }}}}
function cIP(dt){let pP=ctrls.getObject().position;for(let i=sprs.length-1;i>=0;i--){let si=sprs[i];if(!si||!si.object3D||si.isEnemy||!si.type.startsWith('item_'))continue;let dx=pP.x-si.object3D.position.x,dz=pP.z-si.object3D.position.z,dSq=dx*dx+dz*dz;if(dSq<ITEM_PICKUP_RADIUS_SQ){let pk=!1,rm=!0;switch(si.type){case 'item_health':if(php<PLAYER_MAX_HP){php=Math.min(PLAYER_MAX_HP,php+si.value);uH();pk=!0;}else rm=!1;break;case 'item_ammo':if(pam<PLAYER_MAX_AMMO){pam=Math.min(PLAYER_MAX_AMMO,pam+si.value);uH();pk=!0;}else rm=!1;break;case 'item_biggun':if(!pHasBG){pHasBG=!0;sW('biggun');pk=!0;pam=Math.min(PLAYER_MAX_AMMO,pam+si.value);uH();}else{if(pam<PLAYER_MAX_AMMO){pam=Math.min(PLAYER_MAX_AMMO,pam+si.value);uH();pk=!0;}else rm=!1;}break;}if(pk&&rm){dM(si.object3D);delete so[si.id];sprs.splice(i,1);}}}}
function uGA(dt,wD){if(!gMsh||!wD||!wD.idleMaterial||!wD.firingMaterial)return;if(isFA){if(gMsh.material!=wD.firingMaterial){gMsh.material=wD.firingMaterial;wD.firingMaterial.map&&(wD.firingMaterial.map.offset.x=fCF/wD.fireFrames);}fAT-=dt;if(fAT<=0){isFA=!1;fCF=0;gMsh.material=wD.idleMaterial;wD.firingMaterial.map&&(wD.firingMaterial.map.offset.x=0);}else{fFT+=dt;if(fFT>=wD.frameDuration){fCF=(fCF+1)%wD.fireFrames;fFT-=wD.frameDuration;wD.firingMaterial.map&&(wD.firingMaterial.map.offset.x=fCF/wD.fireFrames);}}}else if(gMsh.material!=wD.idleMaterial){gMsh.material=wD.idleMaterial;fCF=0;fFT=0;wD.firingMaterial.map&&(wD.firingMaterial.map.offset.x=0);}}
function cBS(key,pos,rotY=0,scale=1,yo=.001){let tex=as[key];if(!tex)return null;let geo=new THREE.PlaneGeometry(scale,scale),mat=new THREE.MeshBasicMaterial({map:tex.clone(),transparent:!0,opacity:1,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-1,side:TDS});mat.map.needsUpdate=!0;let mesh=new THREE.Mesh(geo,mat);mesh.userData.isBloodSplatter=!0;mesh.position.copy(pos);mesh.position.y+=yo;mesh.rotation.x=-PI/2;mesh.rotation.z=rotY;scn.add(mesh);return {mesh:mesh,material:mat};}
function tS(wD){if(!wD)return;tSLS=0;pam--;uH();isFA=!0;fAT=wD.animationDuration;fCF=0;fFT=0;gMsh&&(gMsh.material=wD.firingMaterial);wD.firingMaterial.map&&(wD.firingMaterial.map.offset.x=0);rc.setFromCamera(new THREE.Vector2(0,0),cam);let iob=scn.children.filter(o=>o!==cGrp&&!dfmsh.includes(o)&&!sdm.includes(o)&&!(dd.some(d=>d.type=='sliding'&&(d.meshLeftFront===o||d.meshLeftBack===o||d.meshRightFront===o||d.meshRightBack===o||d.meshLeft===o||d.meshRight===o)))&&!(dd.some(d=>d.type=='vertical'&&dm[d.meshIndex]===o))&&!(o.geometry instanceof THREE.SphereGeometry && o.material.side === TBS)); 
cGrp&&iob.push(...cGrp.children);let ins=rc.intersectObjects(iob,!0),hit=!1;for(let i of ins){if(i.object===gMsh||(cg&&i.object.parent===cg)||i.object.userData.isBullethole||i.object.userData.isBloodSplatter)continue;if(i.object instanceof THREE.Sprite){let si=Object.values(so).find(s=>s&&s.object3D===i.object);if(si&&si.isEnemy&&si.state!='dying'){let dmg=wD.damage;si.health-=dmg;if(si.health<=0){let ep=si.object3D.position;splBP.set(ep.x,-WALL_HEIGHT/2,ep.z);let s1=cBS('bl',splBP,0,BLOOD_SPLATTER_SIZE);s1&&abs.push({...s1,createdAt:clk.getElapsedTime()});let s2=cBS('bl1',splBP,Math.random()*PI*2,BLOOD_SPLATTER_SIZE*.8,.002);s2&&abs.push({...s2,createdAt:clk.getElapsedTime()});si.state='dying';si.deathTimer=ENEMY_DEATH_DURATION;si.animationTimer=0;scr+=SCORE_PER_KILL;uH();}hit=!0;break;}else continue;}let iwe=i.object.geometry instanceof THREE.BoxGeometry||i.object.geometry instanceof THREE.PlaneGeometry;if(bht&&iwe&&i.face&&i.face.normal){hit=!0;let p=i.point,n=i.face.normal.clone();n.transformDirection(i.object.matrixWorld).normalize();let hG=new THREE.PlaneGeometry(BULLETHOLE_SIZE,BULLETHOLE_SIZE),hM=new THREE.MeshBasicMaterial({map:bht.clone(),color:0xffffff,transparent:!0,opacity:1,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-4,polygonOffsetUnits:-4});hM.map.needsUpdate=!0;let hm=new THREE.Mesh(hG,hM);hm.userData.isBullethole=!0;hm.position.copy(p).addScaledVector(n,.001);hm.lookAt(hm.position.clone().add(n));scn.add(hm);abh.push({mesh:hm,material:hM,createdAt:clk.getElapsedTime()});break;}}}
function uDc(dt,dl,lt,dfn){let now=clk.getElapsedTime();for(let i=dl.length-1;i>=0;i--){let d=dl[i];if(!d||!d.mesh){dl.splice(i,1);continue;}let age=now-d.createdAt;if(age>=lt){dfn(d.mesh);dl.splice(i,1);}else{let fS=.8,fST=lt*fS;d.material.opacity=age>fST?Math.max(0,1-(age-fST)/(lt-fST)):1;}}}
function uBH(dt){uDc(dt,abh,BULLETHOLE_LIFETIME,dM);}
function uBS(dt){uDc(dt,abs,BLOOD_SPLATTER_LIFETIME,dM);}
function uE(dt){let pP=ctrls.getObject().position;for(let i=enms.length-1;i>=0;i--){let ei=enms[i];if(!ei||!ei.object3D||ei.state=='dying')continue;let es=ei.object3D,ep=es.position;let dx=pP.x-ep.x,dz=pP.z-ep.z,dSq=dx*dx+dz*dz;ei.attackCooldown>0&&(ei.attackCooldown-=dt);if(dSq<ENEMY_ATTACK_RANGE_SQ){if(ei.state!='attacking')ei.state='attacking',ei.animationTimer=0,ei.currentFrame=0,ei.lastFrameAction=-1;}else dSq<ENEMY_SIGHT_RANGE_SQ?(ei.state!='chasing'&&(ei.state='chasing',ei.animationTimer=0,ei.currentFrame=0)):(ei.state!='idle'&&(ei.state='idle',ei.animationTimer=0,ei.currentFrame=0));if(ei.state=='chasing'){enMV.set(dx,0,dz).normalize();let move=ei.moveSpeed*dt,tX=ep.x+enMV.x*move,tZ=ep.z+enMV.z*move;cEMT(tX,ep.z,ei.radius)&&(ep.x=tX);cEMT(ep.x,tZ,ei.radius)&&(ep.z=tZ);}let lt=tmpV3.set(cam.position.x,ep.y,cam.position.z);es.lookAt(lt);}}
function uEA(dt){let pP=ctrls.getObject().position;for(let i=enms.length-1;i>=0;i--){let ei=enms[i];if(!ei||!ei.object3D)continue;let es=ei.object3D,ep=es.position;if(ei.state=='dying'){ei.deathTimer-=dt;let ratio=Math.max(0,ei.deathTimer/ENEMY_DEATH_DURATION);es.material&&(es.material.opacity=ratio);if(ei.deathTimer<=0){dM(es);if(ei.idleMaterial){ei.idleMaterial.map?.dispose();ei.idleMaterial.dispose();}if(ei.attackMaterial){ei.attackMaterial.map?.dispose();ei.attackMaterial.dispose();}delete so[ei.id];let sIdx=sprs.findIndex(s=>s&&s.id===ei.id);sIdx>-1&&sprs.splice(sIdx,1);enms.splice(i,1);continue;}}else es.material?.opacity<1&&(es.material.opacity=1);if(ei.state=='dying')continue;ei.animationTimer+=dt;let dur,count,mat,tex,nf;if(ei.state=='attacking'){mat=ei.attackMaterial;dur=ENEMY_ATTACK_FRAME_DURATION;nf=ENEMY_ATTACK_FRAMES;}else if(ei.state=='chasing'){mat=ei.walkMaterial;dur=ENEMY_IDLE_FRAME_DURATION;nf=ENEMY_IDLE_FRAMES;}else{mat=ei.idleMaterial;dur=ENEMY_IDLE_FRAME_DURATION;nf=ENEMY_IDLE_FRAMES;}count=nf;tex=mat?.map;if(es.material!=mat&&mat){es.material=mat;ei.animationTimer=0;ei.currentFrame=0;tex&&(tex.offset.x=0);ei.lastFrameAction=-1;}if(tex&&dur>0&&count){let prev=ei.currentFrame;while(ei.animationTimer>=dur){ei.currentFrame=(ei.currentFrame+1)%count;ei.animationTimer-=dur;}if(ei.currentFrame!=prev)tex.offset.x=ei.currentFrame/nf;if(ei.state=='attacking'&&ei.currentFrame==ENEMY_ATTACK_DAMAGE_FRAME&&ei.lastFrameAction!=ENEMY_ATTACK_DAMAGE_FRAME){ei.lastFrameAction=ei.currentFrame;if(ei.attackCooldown<=0){let dx=pP.x-ep.x,dz=pP.z-ep.z,dSq=dx*dx+dz*dz;if(dSq<ENEMY_ATTACK_RANGE_SQ){php-=ENEMY_DAMAGE;php=Math.max(0,php);uH();ei.attackCooldown=ENEMY_ATTACK_COOLDOWN;if(php<=0){tGO();return;}}}}if(ei.currentFrame==0&&prev!=0)ei.lastFrameAction=-1;}}}
function tGO(){if(!gr)return;gr=!1;mvF=mvB=stL=stR=jmpR=shtR=!1;mvJoy?.rst();isMobile||!isPL?document.body.style.cursor='default':ctrls.unlock();isPL=!1;he&&(he.style.display='none');fse&&(fse.textContent=scr);goe&&(goe.style.display='flex');animFrameId&&(cancelAnimationFrame(animFrameId),animFrameId=null);}
function uH(){if(!hve||!hbe||!have||!haie||!hse)return;hve.textContent=Math.max(0,Math.round(php));let hpP=Math.min(1,Math.max(0,php/PLAYER_MAX_HP));hbe.style.width=`${hpP*100}%`;hbe.style.backgroundColor=hpP>.5?'#0f0':hpP>.2?'#ff0':'#f00';if(as['hud_b']&&as['hud_b'].image){have.textContent=pam;haie.innerHTML='';for(let i=0;i<MAX_AMMO_INDICATORS;i++){let img=document.createElement('img');img.src=as['hud_b'].image.src;img.alt='b';img.classList.toggle('empty',pam<=i*BULLETS_PER_INDICATOR);haie.appendChild(img);}}hse.textContent=`Score: ${scr}`;}
function cMT(tX,tZ,r){let gx=((tX+mapOffsetX+Math.sign(tX-ctrls.getObject().position.x)*r)/CELL_SIZE)|0,gy=((tZ+mapOffsetZ+Math.sign(tZ-ctrls.getObject().position.z)*r)/CELL_SIZE)|0;return!iMW(gx,gy);}
function cEMT(tX,tZ,r){let gx=((tX+mapOffsetX)/CELL_SIZE)|0,gy=((tZ+mapOffsetZ)/CELL_SIZE)|0;if(iMW(gx,gy))return!1;gx=((tX+mapOffsetX+r)/CELL_SIZE)|0;gy=((tZ+mapOffsetZ+r)/CELL_SIZE)|0;if(iMW(gx,gy))return!1;gx=((tX+mapOffsetX-r)/CELL_SIZE)|0;gy=((tZ+mapOffsetZ+r)/CELL_SIZE)|0;if(iMW(gx,gy))return!1;gx=((tX+mapOffsetX+r)/CELL_SIZE)|0;gy=((tZ+mapOffsetZ-r)/CELL_SIZE)|0;if(iMW(gx,gy))return!1;gx=((tX+mapOffsetX-r)/CELL_SIZE)|0;gy=((tZ+mapOffsetZ-r)/CELL_SIZE)|0;return!iMW(gx,gy);}
function iMW(gx,gy){if(gx<0||gx>=MAP_WIDTH||gy<0||gy>=MAP_HEIGHT)return!0;let ct=md[gy]?.[gx];if(ct==null)return!0;if(ct>0&&ct!=DOOR_MARKER&&ct!=SLIDING_DOOR_MARKER)return!0;if(ct==DOOR_MARKER||ct==SLIDING_DOOR_MARKER){let d=dMap[gy]?.[gx];return d&&d.offset<DOOR_FULLY_OPEN_OFFSET*.5;}return cPos.some(p=>p.gridX===gx&&p.gridY===gy);}
function oWR(){let w=window.innerWidth,h=window.innerHeight;cam.aspect=w/h;cam.updateProjectionMatrix();rend.setSize(w,h);USE_POSTPROCESSING&&cmp&&cmp.setSize(w,h);}
function rG(){gr=!1;goe&&(goe.style.display='none');cSO();cMg();aDF();aKR();aMC();sSO();sPS();mvF=mvB=stL=stR=jmpR=shtR=!1;lkTId=null;lstLkX=0;mvJoy?.rst();he&&(he.style.display='block');uH();animFrameId||(gr=!0,anim());}
window.addEventListener('load',iG);
class Joy{constructor(c,k){this.container=c;this.knob=k;this.cx=0;this.cy=0;this.mD=c.offsetWidth/2-k.offsetWidth/2;this.cX=0;this.cY=0;this.a=!1;this.tId=null;this.iM=!1;let opts={passive:!1};c.addEventListener("touchstart",e=>this.st(e),opts);c.addEventListener("touchmove",e=>this.mv(e),opts);c.addEventListener("touchend",e=>this.en(e),opts);c.addEventListener("touchcancel",e=>this.en(e),opts);c.addEventListener("mousedown",e=>this.stM(e));document.addEventListener("mousemove",e=>this.mvM(e));document.addEventListener("mouseup",e=>this.enM(e));}st(e){if(!gr)return;e.preventDefault();if(this.a)return;let t=e.changedTouches[0];this.tId=t.identifier;this.a=!0;let rect=this.container.getBoundingClientRect();this.cx=rect.left+rect.width/2;this.cy=rect.top+rect.height/2;this.uPos(t);}mv(e){if(!this.a||!gr)return;let t=null;for(let i=0;i<e.changedTouches.length;i++){if(e.changedTouches[i].identifier===this.tId){t=e.changedTouches[i];break;}}if(t){e.preventDefault();this.uPos(t);}}en(e){if(!this.a)return;let touchEnded=!1;for(let i=0;i<e.changedTouches.length;i++){if(e.changedTouches[i].identifier===this.tId){touchEnded=!0;break;}}touchEnded&&this.rJS();}stM(e){if(!gr||e.button||this.a)return;e.preventDefault();this.a=!0;this.iM=!0;let rect=this.container.getBoundingClientRect();this.cx=rect.left+rect.width/2;this.cy=rect.top+rect.height/2;this.uPos(e);}mvM(e){if(!this.a||!this.iM||!gr)return;e.preventDefault();this.uPos(e);}enM(e){(!this.a||!this.iM||e.button)&&this.rJS();}uPos(es){let clX,clY;es.identifier!=null?(clX=es.clientX,clY=es.clientY):(clX=es.clientX,clY=es.clientY);let dx=clX-this.cx,dy=clY-this.cy,dSq=dx*dx+dy*dy,mDSq=this.mD*this.mD,cx_=dx,cy_=dy;if(dSq>mDSq){let dist=Math.sqrt(dSq);cx_=(dx/dist)*this.mD;cy_=(dy/dist)*this.mD;}this.cX=cx_/this.mD;this.cY=cy_/this.mD;this.knob.style.transform=`translate(${cx_}px, ${cy_}px)`;}rJS(){this.a=!1;this.tId=null;this.iM=!1;this.cX=0;this.cY=0;this.knob.style.transform=`translate(0px, 0px)`;mvF=mvB=stL=stR=!1;}rst(){this.rJS();}}
</script></body></html>