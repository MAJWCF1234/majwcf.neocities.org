<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElaiOS</title>
    <style>
        /* Windows 95 Theme */
        :root {
            --win95-gray: #c0c0c0;
            --win95-dark: #808080;
            --win95-darker: #404040;
            --win95-light: #ffffff;
            --win95-blue: #000080;
            --win95-text: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "MS Sans Serif", "Segoe UI", Tahoma, sans-serif;
            user-select: none; /* Prevent text selection */
        }

        body {
            background: #00807F; /* Win95 Teal */
            height: 100vh;
            overflow: hidden;
            cursor: default;
        }

        /* Windows 95 Button Style */
        .win95-btn {
            background: var(--win95-gray);
            border: 2px solid;
            border-color: var(--win95-light) var(--win95-darker) var(--win95-darker) var(--win95-light);
            padding: 4px 8px;
            color: var(--win95-text);
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: none; /* Remove transitions for authentic feel */
            text-align: center;
            min-width: 75px; /* Standard button width */
            min-height: 21px; /* Standard button height */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .win95-btn:active {
            border-color: var(--win95-darker) var(--win95-light) var(--win95-light) var(--win95-darker);
            padding: 5px 7px 3px 9px; /* Inset effect */
            background: #bdbdbd; /* Slightly darker gray when pressed */
        }

        /* Login Screen */
        #login-screen {
            background: #000; /* Black screen before OS loads */
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000; /* Highest z-index */
        }

        .login-container {
            background: var(--win95-gray);
            border: 2px solid;
            border-color: var(--win95-light) var(--win95-darker) var(--win95-darker) var(--win95-light);
            padding: 16px;
            width: 300px;
            box-shadow: 2px 2px 0px var(--win95-darker), 4px 4px 0px #000; /* Subtle shadow */
        }

        .login-header {
            background: var(--win95-blue);
            color: white;
            padding: 3px 5px;
            margin: -16px -16px 16px -16px;
            font-weight: bold;
            font-size: 12px;
            text-align: left; /* Align left like title bars */
        }

        .login-form label {
            display: block;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .login-form input {
            width: 100%;
            padding: 4px;
            margin-bottom: 8px;
            border: 2px solid;
            border-color: var(--win95-darker) var(--win95-light) var(--win95-light) var(--win95-darker);
            font-size: 12px;
            background: var(--win95-light);
        }

        .login-footer {
            margin-top: 16px;
            font-size: 11px;
            text-align: center;
            color: var(--win95-dark);
        }

        /* Desktop */
        .desktop {
            height: calc(100vh - 28px); /* Full height minus taskbar */
            padding: 8px;
            overflow: hidden; /* Prevent scrollbars on desktop itself */
            background-color: #00807F; /* Match body */
            display: flex;
            flex-direction: column; /* Stack icons vertically */
            flex-wrap: wrap; /* Wrap icons to next column */
            align-items: flex-start;
            align-content: flex-start; /* Align columns to the start */
            position: relative;
        }

        /* Taskbar */
        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 28px;
            background: var(--win95-gray);
            border-top: 2px solid var(--win95-light);
            display: flex;
            align-items: center;
            padding: 2px;
            z-index: 5000; /* Below windows but above desktop */
        }

        .start-button {
            display: flex;
            align-items: center;
            background: var(--win95-gray);
            border: 2px solid;
            border-color: var(--win95-light) var(--win95-darker) var(--win95-darker) var(--win95-light);
            padding: 2px 6px;
            margin-right: 4px;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            min-width: 60px;
            height: 22px;
        }
         .start-button:active {
             border-color: var(--win95-darker) var(--win95-light) var(--win95-light) var(--win95-darker);
             padding: 3px 5px 1px 7px; /* Inset effect */
         }

        .start-button img {
            width: 16px;
            height: 16px;
            margin-right: 4px;
        }

        .taskbar-divider {
            width: 2px;
            height: 20px;
            border-left: 1px solid var(--win95-darker);
            border-right: 1px solid var(--win95-light);
            margin: 0 4px;
        }

        #active-windows {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-grow: 1; /* Allow taskbar buttons to take space */
            overflow: hidden; /* Prevent overflow if too many windows */
        }

        .active-window-btn {
            background: var(--win95-gray);
            border: 2px solid;
            border-color: var(--win95-light) var(--win95-darker) var(--win95-darker) var(--win95-light);
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
            height: 22px;
            max-width: 150px; /* Limit button width */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 0; /* Prevent buttons from shrinking too much */
            min-width: 80px;
        }

        .active-window-btn.active { /* Style for the currently focused window's button */
             border-color: var(--win95-darker) var(--win95-light) var(--win95-light) var(--win95-darker);
             background: #bdbdbd; /* Slightly darker gray when active */
             font-weight: bold;
             padding: 3px 5px 1px 7px; /* Inset effect */
        }

        .system-tray {
            margin-left: auto; /* Pushes tray to the right */
            display: flex;
            align-items: center;
            border: 1px solid; /* Indented border */
            border-color: var(--win95-darker) var(--win95-light) var(--win95-light) var(--win95-darker);
            padding: 1px;
            height: 22px;
        }

        .system-time {
            background: var(--win95-gray);
            padding: 2px 4px;
            font-size: 11px;
            color: var(--win95-text);
        }

        /* Desktop Icons */
        .desktop-icon {
            width: 75px;
            height: 75px; /* Fixed height for grid alignment */
            text-align: center;
            margin: 4px; /* Reduced margin */
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            padding: 4px;
            border: 1px solid transparent; /* For focus/selection outline */
        }

        .desktop-icon:focus, .desktop-icon:active {
             background-color: rgba(0, 0, 128, 0.5); /* Blue selection highlight */
             border: 1px dotted var(--win95-light);
             outline: none;
         }

        .desktop-icon img {
            width: 32px;
            height: 32px;
            margin-bottom: 4px;
        }

        .desktop-icon span {
            font-size: 11px;
            background: transparent; /* Remove blue background */
            padding: 1px 2px;
            border-radius: 0;
            display: block;
            word-wrap: break-word; /* Wrap long names */
            max-height: 30px; /* Limit text height */
            overflow: hidden;
        }

        /* Windows */
        .window {
            position: absolute;
            background: var(--win95-gray);
            border: 2px solid;
            border-color: var(--win95-light) var(--win95-darker) var(--win95-darker) var(--win95-light);
            min-width: 250px;
            min-height: 150px;
            display: none; /* Initially hidden */
            z-index: 1000; /* Base z-index for windows */
            box-shadow: 2px 2px 0px var(--win95-darker), 4px 4px 0px #000; /* Subtle shadow */
            overflow: hidden; /* Prevent content spilling out */
            /* Default position */
            top: 50px;
            left: 50px;
        }

        .window.active { /* When window is focused */
             z-index: 4000 !important; /* Bring active window above others */
        }

        .window-header {
            background: var(--win95-blue);
            color: white;
            padding: 3px 5px;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            height: 20px;
        }

        .window.active .window-header { /* Active window header style */
            background: var(--win95-blue);
        }
        .window:not(.active) .window-header { /* Inactive window header style */
             background: var(--win95-dark);
             color: #c0c0c0; /* Dimmed text */
         }


        .window-controls {
            display: flex;
            gap: 2px;
        }

        .window-button {
            width: 16px;
            height: 14px;
            background: var(--win95-gray);
            border: 1px solid;
            border-color: var(--win95-light) var(--win95-darker) var(--win95-darker) var(--win95-light);
            font-size: 10px;
            font-family: "Marlett", "MS Sans Serif"; /* Use Marlett for symbols if available */
            line-height: 12px;
            text-align: center;
            color: var(--win95-text);
            cursor: pointer;
            padding: 0;
            margin: 0;
            font-weight: bold;
        }

        .window-button:active {
            border-color: var(--win95-darker) var(--win95-light) var(--win95-light) var(--win95-darker);
        }

        .window-content {
            padding: 0; /* Remove padding, let content handle it */
            background: white; /* Content area background */
            border: 2px solid;
            border-color: var(--win95-darker) var(--win95-light) var(--win95-light) var(--win95-darker);
            margin: 2px;
            height: calc(100% - 24px); /* Header height + margin */
            overflow: auto; /* Allow content to scroll */
        }

        /* Chat Window Specifics */
        #webchat .window-content {
            overflow: hidden; /* Prevent double scrollbars */
        }
        .chat-container {
            display: flex;
            height: 100%;
        }

        .chat-sidebar {
            width: 100px; /* Narrower sidebar */
            background: var(--win95-gray);
            border-right: 2px solid var(--win95-darker);
            padding: 4px;
            overflow-y: auto;
            height: 100%;
        }

        .chat-contact {
            padding: 4px;
            margin: 2px 0;
            font-size: 11px; /* Smaller font */
            cursor: pointer;
            border-radius: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid transparent;
        }

        .chat-contact:hover {
            background: var(--win95-blue);
            color: white;
        }
         .chat-contact.active {
             background: var(--win95-blue);
             color: white;
             font-weight: bold;
         }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--win95-light); /* White background for chat area */
        }

        .chat-messages {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
            background: white;
            border: none; /* Remove extra border */
            margin-bottom: 0; /* Remove margin */
        }

        .message {
            margin-bottom: 8px;
            font-size: 12px;
            max-width: 85%; /* Prevent messages taking full width */
            clear: both; /* Ensure messages don't overlap floats */
        }

        .message.sent {
            float: right;
            text-align: right;
        }
        .message.received {
            float: left;
            text-align: left;
        }


        .message .sender {
             font-weight: bold;
             font-size: 10px;
             color: var(--win95-dark);
             display: block; /* Sender on its own line */
             margin-bottom: 2px;
        }
        .message.sent .sender { color: var(--win95-blue); }
        .message.received .sender { color: #008000; } /* Green for received sender */

        .message .content {
            display: inline-block; /* Wrap content tightly */
            padding: 5px 8px;
            border-radius: 5px;
            background-color: #e0e0e0; /* Light grey bubble */
            text-align: left; /* Always left-align text inside bubble */
            margin-top: 2px;
        }
        .message.sent .content {
            background-color: #d0e0f0; /* Light blue bubble for sent */
        }

        .message .message-time {
            font-size: 9px;
            color: var(--win95-dark);
            display: block;
            margin-top: 3px;
        }

        .chat-input-area {
            border-top: 2px solid var(--win95-darker);
            padding: 4px;
            background: var(--win95-gray);
        }
        #chat-choices {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 4px;
            padding: 4px;
        }
        .choice-button {
            background: var(--win95-gray);
            border: 2px solid;
            border-color: var(--win95-light) var(--win95-darker) var(--win95-darker) var(--win95-light);
            padding: 4px 8px;
            text-align: left;
            font-size: 11px;
            cursor: pointer;
            flex-grow: 1; /* Allow buttons to grow */
            min-width: 45%; /* Try to fit two per row */
        }
        .choice-button:active {
            border-color: var(--win95-darker) var(--win95-light) var(--win95-light) var(--win95-darker);
        }

        .chat-input {
            display: flex;
            gap: 4px;
        }

        .chat-input input {
            flex: 1;
            padding: 4px;
            border: 2px solid;
            border-color: var(--win95-darker) var(--win95-light) var(--win95-light) var(--win95-darker);
            font-size: 12px;
            height: 22px;
        }
        .chat-input .win95-btn {
            min-width: 60px; /* Smaller send button */
        }

        /* Browser Window */
        #browser .window-content {
            display: flex;
            flex-direction: column;
            padding: 0; /* Reset padding */
        }
        .browser-toolbar {
            padding: 4px;
            display: flex;
            gap: 4px;
            background: var(--win95-gray);
            border-bottom: 1px solid var(--win95-darker); /* Thinner line */
            flex-shrink: 0; /* Prevent toolbar shrinking */
            align-items: center;
        }
        .browser-toolbar .win95-btn {
            min-width: 30px; /* Smaller nav buttons */
            padding: 2px 4px;
            font-size: 14px; /* Larger symbols */
        }

        .url-bar {
            flex: 1;
            padding: 3px 4px;
            border: 2px solid;
            border-color: var(--win95-darker) var(--win95-light) var(--win95-light) var(--win95-darker);
            font-size: 12px;
            background: var(--win95-light);
            height: 22px;
        }
        .browser-toolbar .go-btn {
            min-width: 40px;
        }

        #webpage-content {
            flex-grow: 1;
            overflow-y: auto;
            background: white;
            padding: 10px; /* Padding inside the content area */
            font-family: 'Times New Roman', serif; /* Classic web font */
            font-size: 14px;
            line-height: 1.5;
        }
        /* Geocities style elements */
        #webpage-content h1 { font-size: 24px; color: #000080; margin-bottom: 10px; font-family: 'Comic Sans MS', cursive; text-align: center; }
        #webpage-content h2 { font-size: 18px; color: #800080; margin-top: 15px; margin-bottom: 8px; font-family: 'Comic Sans MS', cursive; }
        #webpage-content h3 { font-size: 16px; color: #008080; margin-top: 10px; margin-bottom: 5px; }
        #webpage-content p { margin-bottom: 10px; }
        #webpage-content a { color: #0000FF; text-decoration: underline; }
        #webpage-content a:visited { color: #800080; }
        #webpage-content marquee { background-color: yellow; color: red; font-weight: bold; padding: 5px; margin: 10px 0; }
        #webpage-content .news-headline { font-weight: bold; color: #a00; }
        #webpage-content .news-footer { font-size: 11px; color: gray; text-align: right; font-style: italic; }
        #webpage-content .forum-thread { border: 1px dashed #ccc; padding: 10px; margin-bottom: 10px; background: #f0f0f0; }
        #webpage-content .forum-thread h3 { margin: 0 0 5px 0; }
        #webpage-content .forum-meta { font-size: 11px; color: #555; }
        #webpage-content .locked { color: red; font-weight: bold; }
        #webpage-content .corrupted { color: red; font-style: italic; }
        #webpage-content .memorial-entry { border: 2px solid #555; padding: 15px; margin: 20px auto; background: #111; color: #eee; max-width: 400px; text-align: center; }
        #webpage-content .memorial-entry h2 { color: #eee; }
        #webpage-content .hidden-code { font-family: monospace; color: #333; background: #333; /* Hide text */}
        #webpage-content .hidden-code:hover { color: yellow; background: #222; } /* Reveal on hover */


        /* Notepad */
        #notepad .window-content { padding: 0; }
        #notepad textarea {
            width: 100%;
            height: 100%;
            resize: none;
            border: none;
            outline: none;
            font-family: 'Courier New', monospace; /* Monospace font */
            font-size: 12px;
            padding: 4px;
             background: white;
             color: black;
        }

        /* Calculator */
        #calculator .window-content { padding: 8px; background: var(--win95-gray); }
        .calculator-grid {
             width: 200px;
             margin: 0 auto;
        }
        #calc-display {
            width: 100%;
            padding: 5px;
            font-size: 16px;
            text-align: right;
            border: 2px solid;
            border-color: var(--win95-darker) var(--win95-light) var(--win95-light) var(--win95-darker);
            margin-bottom: 5px;
            background: white;
            font-family: 'Courier New', monospace;
             height: 28px;
        }
        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
        }
        .calc-buttons .win95-btn {
             min-width: 0; /* Override default min-width */
             padding: 4px;
             font-size: 14px;
         }

        /* Settings */
         #settings .window-content { padding: 15px; }
         #settings h3 { margin-bottom: 10px; }
         #settings p { margin-bottom: 15px; font-size: 12px; }

        /* CRT Effect */
        .crt::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 1; /* Below login/windows */
            background-size: 100% 2px, 3px 100%;
            pointer-events: none; /* Allows interaction with elements behind it */
        }

        .screen {
            display: none; /* Hide screens by default */
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        .active-screen {
            display: block; /* Show the active screen */
            z-index: 5; /* Ensure desktop is above CRT */
        }

        /* Start Menu */
        #start-menu {
            display: none;
            position: fixed;
            bottom: 28px; /* Above taskbar */
            left: 2px;
            background: var(--win95-gray);
            border: 2px solid;
            border-color: var(--win95-light) var(--win95-darker) var(--win95-darker) var(--win95-light);
            width: 180px; /* Slightly narrower */
            z-index: 6000; /* Above taskbar */
            box-shadow: 2px 2px 0px var(--win95-darker), 4px 4px 0px #000;
        }

        #start-menu .menu-header { /* Vertical header */
             float: left;
             width: 25px;
             height: 100%;
             background: var(--win95-blue);
             color: white;
             writing-mode: vertical-lr;
             transform: rotate(180deg); /* Correct orientation */
             text-align: right;
             padding: 8px 4px;
             font-weight: bold;
             font-size: 16px;
             position: absolute;
             left: 0;
             top: 0;
             bottom: 0;
        }

        #start-menu .menu-items {
            padding: 4px;
            margin-left: 29px; /* Space for vertical header */
        }

        #start-menu .menu-items .win95-btn {
            width: 100%;
            margin-bottom: 4px;
            text-align: left;
            font-weight: normal; /* Normal weight for menu items */
            min-width: 0; /* Allow smaller buttons */
            padding: 3px 8px; /* Adjust padding */
             display: flex; /* Align icon and text */
             align-items: center;
             justify-content: flex-start;
        }
        #start-menu .menu-items .win95-btn img {
            width: 16px;
            height: 16px;
            margin-right: 6px;
        }
        #start-menu hr {
            border: none;
            border-top: 1px solid var(--win95-darker);
            border-bottom: 1px solid var(--win95-light);
            margin: 4px 0;
        }


        /* Responsive Adjustments (Simplified) */
        @media (max-width: 600px) {
             /* Make windows take up more space on small screens */
            .window {
                min-width: 90%;
                width: 90% !important; /* Force width */
                min-height: 70%;
                height: 70% !important; /* Force height */
                left: 5% !important;
                top: 5% !important;
            }
            .login-container { width: 90%; }
            .desktop-icon { width: 60px; height: 60px; margin: 2px;}
            .desktop-icon img { width: 24px; height: 24px;}
            .desktop-icon span { font-size: 10px; max-height: 25px; }
            .taskbar { height: 32px; }
            .desktop { height: calc(100vh - 32px); }
            .start-button { height: 28px; }
            .active-window-btn { height: 28px; max-width: 80px; font-size: 10px; min-width: 50px;}
            .system-tray { height: 28px; }
            .system-time { font-size: 10px; padding: 1px 3px;}
            #start-menu { bottom: 32px; }
             .chat-sidebar { display: none; } /* Hide sidebar on very small screens */
             .chat-main { border-left: none;}
             .calculator-grid { width: 100%; }
             .calc-buttons .win95-btn { font-size: 12px; }
        }
    </style>
</head>
<body>
    <div id="screen" class="crt">
        <!-- Login Screen -->
        <div id="login-screen" class="screen active-screen">
            <div class="login-container">
                <div class="login-header">ElaiOS Login</div>
                <div class="login-form">
                    <label for="username">Username:</label>
                    <input type="text" id="username" value="Player" maxlength="20" autocomplete="username" aria-label="Username">
                    <label for="password">Password:</label>
                    <input type="password" id="password" autocomplete="current-password" aria-label="Password" value="password"> <!-- Placeholder password -->
                    <div style="text-align: center; margin-top: 16px;">
                        <button class="win95-btn" id="login-button" aria-label="Login">OK</button>
                    </div>
                </div>
                <div class="login-footer">
                    ElaiOS Version 2.3.1<br>
                    © 1999 ElaiOS Systems Inc.
                </div>
            </div>
        </div>

        <!-- Desktop -->
        <div id="desktop-screen" class="screen">
            <div class="desktop" id="desktop-icons">
                <!-- Desktop Icons - Will be populated by JS -->
            </div>

            <!-- Taskbar -->
            <div class="taskbar">
                <div class="start-button" id="start-button" aria-label="Start Menu" tabindex="0">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAKVJREFUOE/dkksKgDAMRd/NIIgH8QBFkA/kQxQkKNWFQVQQvdQmc7L/zITTFG06/hMY58EiHiE/lo4p47/Qo499+P64gC9yG5LgxjUEcdC1D1AGqtZ56fK6uOQV8EzQBS8FjfUqgqaQQYHKFDRFlEwAgQgcxo8lAsAGgC0GApQzoqQMICcMhQk588BWEGAQAGAB2Q7A8wLALsBgFUGgO+k97eP4f46+AyjM781UAAAAASUVORK5CYII=" alt="Start Icon">
                    Start
                </div>
                <div class="taskbar-divider"></div>
                <div id="active-windows"></div>
                <div class="system-tray">
                    <div class="system-time" id="system-time">12:00:00 PM</div>
                </div>
            </div>

            <!-- Start Menu (Hidden by Default) -->
            <div id="start-menu">
                <div class="menu-header">ElaiOS</div>
                <div class="menu-items" id="start-menu-items">
                    <!-- Start Menu Items - Will be populated by JS -->
                     <hr>
                     <button class="win95-btn" id="shutdown-button" aria-label="Shutdown System">
                         <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAQFJREFUOE+dkrENgkAQRV8noAROkBI6AU5AmQBOgBOkBG4BJ6QTQAk4AU6AE/j3AwpK9pLdOYR3dtkd3vvdnX1t7QkAn9oFAS/g81EBaAB44P0MA/h8+SP78/w/wP0H+QAsAF4AmAEAnwJ4ARBATQwAEAB+AGAA3gBQRwAIE4YAPQDwAFgAVABCAHAAcACAEuTPAyAAp1wQjK3z7gOkBNqjQBoAVL7gGfsLAHoBFQA+AdgB+AZwApARgH3AGcBZAEsAJwA3ABIAVAAkACsAdgA9ALwB1ABuAFIAXgCgAOYAXgGMAJQAjACmALYAYgAUAIwAdgAOAHz4AXnM+b8AWADOAJYAkAAQADIBfgC+AMgG8BX4/gL79AUdcryd+DQAAAABJRU5ErkJggg==" alt="Shutdown Icon">
                         Sh<u>u</u>t Down...
                     </button>
                </div>
            </div>

            <!-- Windows Area -->
            <div id="windows-container">
                 <!-- Windows will be appended here by JS -->
            </div>
        </div>
    </div>

    <script>
        (function() {
            // --- Utilities ---
            function debounce(func, delay) {
                let debounceTimer;
                return function(...args) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func.apply(this, args), delay);
                };
            }

            function safeEval(expression) {
                // More restrictive: only numbers, decimal points, basic operators, spaces. No parentheses for simplicity.
                expression = expression.replace(/\s+/g, ''); // Remove spaces
                if (/^[\d.]+([+\-*/][\d.]+)*$/.test(expression)) {
                    try {
                        // eslint-disable-next-line no-new-func
                        const result = Function('"use strict";return (' + expression + ')')();
                        return Number.isFinite(result) ? result : "Error";
                    } catch (e) {
                        return "Error";
                    }
                } else if (expression === '') {
                     return ''; // Allow clearing
                } else {
                    return "Error"; // Changed from "Invalid Input"
                }
            }

            let highestZIndex = 4000;

            // --- Classes ---

            class WindowManager {
                constructor(elaiOS) {
                    this.elaiOS = elaiOS; // Reference back to main OS
                    this.windows = {}; // Store window instances by id
                    this.activeWindowId = null;
                    this.windowsContainer = document.getElementById('windows-container');
                    this.taskbarButtonsContainer = document.getElementById('active-windows');
                }

                 createWindowElement(id, title, contentHtml) {
                    const windowElement = document.createElement('div');
                    windowElement.id = id;
                    windowElement.className = 'window';
                    windowElement.style.zIndex = highestZIndex++;
                    windowElement.dataset.title = title; // Store title for taskbar

                    windowElement.innerHTML = `
                        <div class="window-header">
                            <span>${title}</span>
                            <div class="window-controls">
                                <button class="window-button" data-action="minimize" aria-label="Minimize ${title}">0</button> <!-- Marlett char -->
                                <button class="window-button" data-action="maximize" aria-label="Maximize ${title}">1</button> <!-- Marlett char -->
                                <button class="window-button" data-action="close" aria-label="Close ${title}">r</button> <!-- Marlett char -->
                            </div>
                        </div>
                        <div class="window-content">
                            ${contentHtml}
                        </div>
                    `;
                    this.windowsContainer.appendChild(windowElement);
                    this.addEventListeners(windowElement);
                    return windowElement;
                 }

                 addEventListeners(windowElement) {
                    const header = windowElement.querySelector('.window-header');
                    const controls = windowElement.querySelector('.window-controls');
                    const id = windowElement.id;

                    // Click on window brings to front
                    windowElement.addEventListener('mousedown', (e) => {
                         // Don't activate if clicking on control buttons
                         if (!e.target.closest('.window-controls')) {
                             this.bringToFront(id);
                         }
                    }, true); // Use capture phase

                    // Dragging
                    header.addEventListener('mousedown', (e) => {
                        // Only drag if not clicking on controls
                        if (e.target.closest('.window-controls')) return;
                        // Ensure this window is active before dragging
                         this.bringToFront(id);

                        if (windowElement.dataset.isMaximized === 'true') return; // Don't drag maximized windows

                        const startX = e.clientX;
                        const startY = e.clientY;
                        const initialLeft = windowElement.offsetLeft;
                        const initialTop = windowElement.offsetTop;
                        const desktop = document.getElementById('desktop-screen'); // Or body/window
                        const maxLeft = desktop.clientWidth - windowElement.offsetWidth;
                        const maxTop = desktop.clientHeight - 28 - windowElement.offsetHeight; // Account for taskbar


                        const dragMouseMove = (moveEvent) => {
                            moveEvent.preventDefault(); // Prevent text selection during drag
                            let newLeft = initialLeft + moveEvent.clientX - startX;
                            let newTop = initialTop + moveEvent.clientY - startY;

                             // Constrain dragging within desktop bounds (approximate)
                             newLeft = Math.max(0, Math.min(newLeft, maxLeft));
                             newTop = Math.max(0, Math.min(newTop, maxTop));


                            windowElement.style.left = `${newLeft}px`;
                            windowElement.style.top = `${newTop}px`;
                        };

                        const closeDragElement = () => {
                            document.removeEventListener('mousemove', dragMouseMove);
                            document.removeEventListener('mouseup', closeDragElement);
                             header.style.cursor = 'move';
                        };

                        header.style.cursor = 'grabbing';
                        document.addEventListener('mousemove', dragMouseMove);
                        document.addEventListener('mouseup', closeDragElement);
                    });

                    // Window Controls (Minimize, Maximize, Close)
                    controls.addEventListener('click', (e) => {
                        const button = e.target.closest('button');
                        if (!button) return;
                        const action = button.dataset.action;
                        switch (action) {
                            case 'minimize': this.minimizeWindow(id); break;
                            case 'maximize': this.maximizeWindow(id); break;
                            case 'close': this.closeWindow(id); break;
                        }
                        e.stopPropagation(); // Prevent mousedown on header from firing
                    });
                 }

                openWindow(id, title, contentHtml, options = {}) {
                    if (this.windows[id] && this.windows[id].element.style.display !== 'none') {
                        this.bringToFront(id); // If already open and visible, just bring to front
                        return this.windows[id].element;
                    }

                    let windowElement;
                    if (this.windows[id]) { // If window exists but was hidden (minimized/closed)
                        windowElement = this.windows[id].element;
                        windowElement.style.display = 'block'; // Make it visible
                        if (windowElement.dataset.isMinimized === 'true') {
                             // Restore from minimized state (optional: restore position/size if needed)
                             delete windowElement.dataset.isMinimized;
                        }
                    } else { // Create new window
                        windowElement = this.createWindowElement(id, title, contentHtml);
                        this.windows[id] = { element: windowElement, title: title };
                        // Set initial position/size if provided
                        if (options.top) windowElement.style.top = options.top;
                        if (options.left) windowElement.style.left = options.left;
                        if (options.width) windowElement.style.width = options.width;
                        if (options.height) windowElement.style.height = options.height;
                    }

                    this.bringToFront(id);
                    this.updateTaskbar();
                    console.log(`Opened window: ${id}`);
                    return windowElement;
                }

                closeWindow(id) {
                    const windowData = this.windows[id];
                    if (!windowData || windowData.element.style.display === 'none') return;

                    windowData.element.style.display = 'none';
                    if (this.activeWindowId === id) {
                        this.activeWindowId = null;
                         // Optionally, activate the next highest window
                    }
                    this.updateTaskbar();
                    console.log(`Closed window: ${id}`);
                     // Optional: Completely remove the element and entry from this.windows if it should not be re-opened
                     // windowData.element.remove();
                     // delete this.windows[id];
                }

                minimizeWindow(id) {
                    const windowData = this.windows[id];
                    if (!windowData || windowData.element.style.display === 'none') return;

                    windowData.element.style.display = 'none';
                    windowData.element.dataset.isMinimized = 'true'; // Mark as minimized

                    if (this.activeWindowId === id) {
                        this.activeWindowId = null;
                         // Optionally, activate the next highest window
                    }
                    this.updateTaskbar(); // Keep taskbar button, maybe change its state
                    console.log(`Minimized window: ${id}`);
                }

                 maximizeWindow(id) {
                     const windowData = this.windows[id];
                     if (!windowData) return;
                     const windowElement = windowData.element;

                     if (windowElement.dataset.isMaximized !== 'true') {
                         // Store old style for restoring
                         windowElement.dataset.oldStyle = JSON.stringify({
                             top: windowElement.style.top || `${windowElement.offsetTop}px`,
                             left: windowElement.style.left || `${windowElement.offsetLeft}px`,
                             width: windowElement.style.width || `${windowElement.offsetWidth}px`,
                             height: windowElement.style.height || `${windowElement.offsetHeight}px`
                         });
                         // Apply maximized style
                         windowElement.style.top = '0px';
                         windowElement.style.left = '0px';
                         windowElement.style.width = '100%';
                         windowElement.style.height = `calc(100vh - 28px)`; // Full height minus taskbar
                         windowElement.dataset.isMaximized = 'true';
                         windowElement.querySelector('[data-action="maximize"]').textContent = '2'; // Marlett restore symbol
                          windowElement.querySelector('[data-action="maximize"]').setAttribute('aria-label', `Restore ${windowData.title}`);
                         console.log(`Maximized window: ${id}`);
                     } else {
                         // Restore from maximized
                         const oldStyle = JSON.parse(windowElement.dataset.oldStyle);
                         windowElement.style.top = oldStyle.top;
                         windowElement.style.left = oldStyle.left;
                         windowElement.style.width = oldStyle.width;
                         windowElement.style.height = oldStyle.height;
                         delete windowElement.dataset.isMaximized;
                         delete windowElement.dataset.oldStyle;
                          windowElement.querySelector('[data-action="maximize"]').textContent = '1'; // Marlett maximize symbol
                          windowElement.querySelector('[data-action="maximize"]').setAttribute('aria-label', `Maximize ${windowData.title}`);
                         console.log(`Restored window: ${id}`);
                     }
                      this.bringToFront(id); // Ensure it stays on top after resize
                 }

                bringToFront(id) {
                    const windowData = this.windows[id];
                    if (!windowData || windowData.element.style.display === 'none') return; // Don't bring hidden windows to front visually

                    // Only change visual state if it's not already the active one
                    if (this.activeWindowId !== id) {
                         // Remove active class from previously active window
                         if (this.activeWindowId && this.windows[this.activeWindowId]) {
                             this.windows[this.activeWindowId].element.classList.remove('active');
                         }

                         // Set new active window
                         windowData.element.style.zIndex = highestZIndex++;
                         windowData.element.classList.add('active');
                         this.activeWindowId = id;
                         console.log(`Brought to front: ${id}`);
                     }
                      // Always update taskbar to reflect active state
                     this.updateTaskbar();
                 }

                updateTaskbar() {
                    this.taskbarButtonsContainer.innerHTML = ''; // Clear existing buttons

                    Object.keys(this.windows).forEach(id => {
                        const windowData = this.windows[id];
                        // Show button only if window exists and is not permanently closed (display !== 'none' or is marked as minimized)
                        if (windowData && (windowData.element.style.display !== 'none' || windowData.element.dataset.isMinimized === 'true')) {
                            const button = document.createElement('button');
                            button.className = 'win95-btn active-window-btn';
                            button.textContent = windowData.title;
                            button.dataset.windowId = id;
                             button.setAttribute('aria-label', `Switch to ${windowData.title}`);

                            if (id === this.activeWindowId && windowData.element.style.display !== 'none') {
                                button.classList.add('active'); // Highlight active window's button
                            }

                            button.onclick = () => {
                                // If minimized, restore it visually
                                if (windowData.element.dataset.isMinimized === 'true') {
                                    windowData.element.style.display = 'block';
                                     delete windowData.element.dataset.isMinimized;
                                    this.bringToFront(id); // Must bring to front after display block
                                } else {
                                     this.bringToFront(id); // Otherwise just bring to front
                                }
                            };
                            this.taskbarButtonsContainer.appendChild(button);
                        }
                    });
                }
            }

            class WebBrowser {
                 constructor(elaiOS) {
                     this.elaiOS = elaiOS;
                     this.history = [];
                     this.currentPageIndex = -1;
                     this.pages = {
                         'about:blank': `<p style="text-align: center; margin-top: 50px; color: grey;">Blank Page</p>`,
                         'elaios://home': this.generateHomePage(),
                         'elaios://news': this.generateNewsPage(),
                         'elaios://memorial': this.generateMemorialPage(),
                         'elaios://forum': this.generateForumPage(),
                          'elaios://diary/sarah': this.generateSarahDiary(),
                         // Add more internal pages as needed
                     };
                     this.browserWindow = null; // Reference to the browser window element
                     this.urlBar = null;
                     this.contentArea = null;
                 }

                 setWindow(windowElement) {
                     this.browserWindow = windowElement;
                     this.urlBar = windowElement.querySelector('.url-bar');
                     this.contentArea = windowElement.querySelector('#webpage-content');
                     this.navigateTo('elaios://home'); // Load home page on open
                 }

                generateHomePage() {
                    return `
                        <h1>Welcome to ElaiOS Memories Archive</h1>
                        <marquee>🌟 Preserving Digital Fragments Since 1999 🌟</marquee>
                        <div style="background: #ffffcc; padding: 10px; margin: 10px; border: 1px solid gray;">
                            <h2>System Status</h2>
                            <p><b>09/15/1999 23:50:</b> System integrity check... <span style="color: orange;">Warnings detected.</span></p>
                             <p><b>09/15/1999 01:05:</b> User 'Michael_1984' last activity recorded.</p>
                            <p><b>09/14/1999:</b> <a href="#" onclick="ElaiOSInstance.webBrowser.navigateTo('elaios://memorial'); return false;" aria-label="Navigate to Memorial">Memorial</a> page updated.</p>
                            <p><b>09/10/1999:</b> Chat system logs archived.</p>
                        </div>
                        <div style="background: #e0e0ff; padding: 10px; margin: 10px; border: 1px solid gray;">
                            <h2>Quick Links</h2>
                            <p>
                                <a href="#" onclick="ElaiOSInstance.webBrowser.navigateTo('elaios://news'); return false;" aria-label="Navigate to News Archive">News Archive</a> |
                                <a href="#" onclick="ElaiOSInstance.webBrowser.navigateTo('elaios://diary/sarah'); return false;" aria-label="Navigate to Personal Diaries">Personal Diaries</a> |
                                <a href="#" onclick="ElaiOSInstance.webBrowser.navigateTo('elaios://memorial'); return false;" aria-label="Navigate to Memorial">Memorial</a> |
                                <a href="#" onclick="ElaiOSInstance.webBrowser.navigateTo('elaios://forum'); return false;" aria-label="Navigate to Forums">Forums</a>
                            </p>
                        </div>
                        <div style="background: #ffebcd; padding: 10px; margin: 10px; border: 1px solid gray;">
                            <h2>Message Board Snippets</h2>
                            <p><i>"Sometimes I wonder if we're all just echoes..."</i> - <span style="color: blue;">sarah_1987</span></p>
                            <p><i>"Query: Define 'real'. Response: Insufficient data."</i> - <span style="color: green;">echo_bot</span></p>
                             <p><i>"Can't shake this feeling something's wrong."</i> - <span style="color: purple;">lisa_1998</span></p>
                        </div>
                    `;
                }

                 generateNewsPage() {
                    return `
                        <h1>ElaiOS News Archive</h1>
                        <div style="background: #ffe4e1; padding: 15px; margin: 10px; border: 1px dashed red;">
                            <h3>September 15, 1999 - 23:55</h3>
                            <p class="news-headline">CRITICAL SYSTEM ALERT</p>
                            <p>Unscheduled maintenance in progress due to data anomalies. Service interruptions expected. User data integrity cannot be guaranteed at this time. Please log off if possible.</p>
                            <p class="news-footer">Posted by: SYS_ADMIN</p>
                        </div>
                        <div style="background: #f0f8ff; padding: 15px; margin: 10px; border: 1px solid blue;">
                            <h3>September 14, 1999</h3>
                            <p class="news-headline">Local Teen Reported Missing</p>
                            <p>Authorities are seeking information regarding Michael [REDACTED], 15, last seen online late Wednesday night. Friends reported unusual activity on his account shortly before he went offline. Anyone with information please contact [REDACTED].</p>
                            <p class="news-footer">[Source: Local Gazette Archive - Article partially redacted by ElaiOS Moderator]</p>
                        </div>
                        <div style="background: #e0ffe0; padding: 15px; margin: 10px; border: 1px solid green;">
                            <h3>September 10, 1999</h3>
                            <p class="news-headline">Y2K Bug: Community Preparations</p>
                            <p>As the year 2000 approaches, users are reminded to backup critical data. ElaiOS engineers are working diligently to ensure a smooth transition. Visit the <a href="#" onclick="ElaiOSInstance.webBrowser.navigateTo('elaios://forum'); return false;">Forums</a> for discussion.</p>
                            <p class="news-footer">Posted by: ElaiOS Support</p>
                        </div>
                         <p><a href="#" onclick="ElaiOSInstance.webBrowser.navigateTo('elaios://home'); return false;">&lt;&lt; Back to Home</a></p>
                    `;
                 }

                 generateMemorialPage() {
                    return `
                        <div style="background: #000; color: #ccc; padding: 20px; border: 3px double #555;">
                            <h1 style="color: #eee;">Digital Echoes - In Memoriam</h1>
                            <div class="memorial-entry">
                                <h2>Michael_1984</h2>
                                <p><i>(1984 - ????)</i></p>
                                <p style="color: yellow;">"Last Online: September 15, 1999 - 01:05"</p>
                                <p>"We didn't know it was goodbye." - sarah_1987</p>
                                <p>"Still trying to piece it together." - lisa_1998</p>
                                 <p style="font-size: 10px; color: #444;">Admin Note: Profile locked.</p>
                            </div>
                            <div class="memorial-entry" style="border-color: #800000;">
                                <h2>Lost Connections</h2>
                                <p>For those whose lights went out unexpectedly in the digital dawn.</p>
                                <p>Remembered in the hum of the servers and the static between signals.</p>
                                <p class="hidden-code" title="Hover to reveal">Fragment: 091599-M.DAT CORRUPT</p>
                            </div>
                            <p style="text-align: center; margin-top: 20px;"><a href="#" onclick="ElaiOSInstance.webBrowser.navigateTo('elaios://home'); return false;">&lt;&lt; Return Home</a></p>
                        </div>
                    `;
                 }

                generateForumPage() {
                     return `
                        <h1>ElaiOS Community Forums</h1>
                        <div class="forum-thread" style="border-color: red;">
                            <h3><span class="locked">[LOCKED]</span> Thread: What happened last night?!</h3>
                            <p class="forum-meta">Started by: sarah_1987 on 1999-09-15 08:30</p>
                            <p>Is anyone else seeing this? Michael's offline, the news is weird, the system keeps glitching... [MESSAGE TRUNCATED]...</p>
                            <p><i>Last Post by SYS_ADMIN: "Thread locked pending investigation. Please refrain from speculation."</i></p>
                        </div>
                        <div class="forum-thread" style="border-color: green;">
                            <h3>Thread: Y2K Bug - Share Your Tips</h3>
                            <p class="forum-meta">Started by: TechGuruDave on 1999-09-10</p>
                            <p>Let's pool our knowledge! How are you prepping for the big rollover? BIOS updates? Data backups? Tin foil hats?</p>
                             <p>Pages: [1] [2] ... [ARCHIVED]</p>
                        </div>
                        <div class="forum-thread" style="border-color: blue;">
                            <h3>Thread: System Glitches & Odd Messages</h3>
                            <p class="forum-meta">Started by: echo_bot on 1999-09-13</p>
                            <p>Observation: Increased frequency of unsent message fragments in buffer. Log inconsistencies detected post-09-15-00:00. Correlation with user 'Michael_1984' activity noted. Query: Is the system developing emergent properties or exhibiting data corruption? <span class="corrupted">[DATA FRAGMENT MISSING]</span></p>
                        </div>
                         <div class="forum-thread">
                            <h3>Thread: General Chat</h3>
                            <p class="forum-meta">Started by: lisa_1998 on 1999-09-01</p>
                            <p>Hey everyone! Just a place to hang out. Anyone else feel like this whole Y2K thing is overblown? More worried about my dial-up speed lol.</p>
                        </div>
                         <p><a href="#" onclick="ElaiOSInstance.webBrowser.navigateTo('elaios://home'); return false;">&lt;&lt; Back to Home</a></p>
                    `;
                 }

                 generateSarahDiary() {
                     return `
                        <h1>Sarah's Corner - My Digital Diary</h1>
                        <div style="background: #fff0f5; padding: 15px; border: 1px solid pink; margin-bottom: 15px;">
                            <h2>September 14, 1999 - Late Night</h2>
                            <p>Can't sleep. Talked to Michael for hours tonight. He seemed... different. Distracted. Kept mentioning some weird code he found and something about 'crossing over'. Said he had to try something tonight. I told him not to be stupid. Hope he listens.</p>
                            <p>He promised he'd be online tomorrow. He always keeps his promises.</p>
                         </div>
                         <div style="background: #f5f5f5; padding: 15px; border: 1px solid #ccc; margin-bottom: 15px;">
                             <h2>September 12, 1999</h2>
                             <p>Lisa's worried about the Y2K bug, but I think it's kinda exciting? Like the whole world is holding its breath. David's being weirdly quiet lately. Wonder what's up with him. Chatting feels like the only real thing sometimes.</p>
                         </div>
                           <div style="background: #eee; padding: 10px; border: 1px solid #aaa; margin-bottom: 15px; text-align: center; color: gray;">
                             <p><i>Older entries archived...</i></p>
                         </div>
                         <p><a href="#" onclick="ElaiOSInstance.webBrowser.navigateTo('elaios://home'); return false;">&lt;&lt; Back to Home</a></p>
                     `;
                 }


                 navigateTo(url) {
                     url = url.trim();
                     if (!url) return;

                      console.log(`Attempting navigation to: ${url}`);

                      // Simple check for external URLs (block them for now)
                      if (url.startsWith('http://') || url.startsWith('https://')) {
                         console.warn(`External navigation blocked: ${url}`);
                         this.loadContent('elaios://blocked', `<h1 style="color:red">Navigation Error</h1><p>External website access is currently restricted within ElaiOS.</p><p>Attempted URL: ${url}</p><p><a href="#" onclick="ElaiOSInstance.webBrowser.goBack(); return false;">Go Back</a></p>`);
                          this.updateHistory(url, false); // Add to history but mark as failed?
                         return;
                      }


                     const content = this.pages[url];
                     if (content) {
                         this.loadContent(url, content);
                         this.updateHistory(url);
                     } else {
                         console.warn(`Page not found: ${url}`);
                         this.loadContent(url, `<h1 style="color:red">404 Not Found</h1><p>The requested ElaiOS resource could not be found.</p><p>URL: ${url}</p><p><a href="#" onclick="ElaiOSInstance.webBrowser.goBack(); return false;">Go Back</a></p>`);
                         this.updateHistory(url, false); // Mark as failed?
                     }
                 }

                  updateHistory(url, success = true) {
                      // If navigating forward, truncate forward history
                      if (this.currentPageIndex < this.history.length - 1) {
                         this.history = this.history.slice(0, this.currentPageIndex + 1);
                      }
                     // Avoid adding consecutive duplicates
                     if (this.history[this.history.length - 1]?.url !== url) {
                         this.history.push({ url: url, success: success });
                         this.currentPageIndex = this.history.length - 1;
                     } else if (this.history.length > 0) {
                        // If it's the same URL, ensure the index is correct (e.g., after going back then forward to same page)
                        this.currentPageIndex = this.history.length - 1;
                     }
                 }

                 loadContent(url, html) {
                      if (!this.contentArea || !this.urlBar) {
                         console.error("Browser content area or URL bar not initialized.");
                         return;
                      }
                     this.contentArea.innerHTML = html;
                     this.urlBar.value = url;
                     this.contentArea.scrollTop = 0; // Scroll to top on new page load
                     console.log(`Loaded content for: ${url}`);
                 }

                 goBack() {
                     if (this.currentPageIndex > 0) {
                         this.currentPageIndex--;
                         const historyEntry = this.history[this.currentPageIndex];
                         const content = this.pages[historyEntry.url] || `<h1 style="color:red">404 Not Found</h1><p>The requested ElaiOS resource could not be found.</p><p>URL: ${historyEntry.url}</p>`;
                         this.loadContent(historyEntry.url, content);
                         console.log(`Navigated back to: ${historyEntry.url}`);
                     } else {
                         console.log("No previous page in history.");
                         // Optionally provide user feedback (e.g., disable back button)
                     }
                 }

                 goForward() {
                     if (this.currentPageIndex < this.history.length - 1) {
                         this.currentPageIndex++;
                         const historyEntry = this.history[this.currentPageIndex];
                          const content = this.pages[historyEntry.url] || `<h1 style="color:red">404 Not Found</h1><p>The requested ElaiOS resource could not be found.</p><p>URL: ${historyEntry.url}</p>`;
                          this.loadContent(historyEntry.url, content);
                         console.log(`Navigated forward to: ${historyEntry.url}`);
                     } else {
                         console.log("No next page in history.");
                         // Optionally provide user feedback
                     }
                 }

                 refresh() {
                      if (this.currentPageIndex >= 0) {
                         const currentUrl = this.history[this.currentPageIndex].url;
                         console.log(`Refreshing: ${currentUrl}`);
                         this.navigateTo(currentUrl); // Reload current URL
                      }
                 }
             }


            class ChatSystem {
                constructor(elaiOS) {
                    this.elaiOS = elaiOS;
                    this.currentChatContactId = null;
                    this.username = 'Player'; // Default username
                    this.messageHistory = {}; // { contactId: [ { sender, text, time }, ... ] }
                    this.storyProgress = {}; // { contactId: currentStoryIndex }
                    this.relationships = {}; // { contactId: score }

                    this.chatWindow = null;
                    this.sidebar = null;
                    this.messagesDiv = null;
                    this.choicesDiv = null;
                    this.input = null;

                    this.contacts = {
                        'sarah_1987': {
                            name: 'Sarah',
                            status: 'online',
                            story: [
                                { // Index 0
                                    trigger: 'initial',
                                    messages: [
                                        "Hey... {username}? Is that you?",
                                        "Wow. It's been forever. Since... well, you know.",
                                        "How are you even back on here? Thought this place was a ghost town."
                                    ],
                                    choices: [
                                        { text: "It's complicated.", points: 1, next: 1 },
                                        { text: "I missed this place.", points: 0, next: 1 },
                                        { text: "What happened back then?", points: 2, next: 2 } // Jump ahead
                                    ]
                                },
                                { // Index 1 (Follows from choice 0 or 1)
                                    response: "Yeah, complicated sounds about right. Everything feels complicated now. Especially after Michael...",
                                    messages: ["...Sorry. Shouldn't bring him up.", "It's just... hard. Still.", "Have you checked the <a href='#' onclick=\"ElaiOSInstance.webBrowser.navigateTo('elaios://memorial'); return false;\">Memorial</a> page they put up?"],
                                    choices: [
                                        { text: "I'll check it out.", points: 1, next: 3 },
                                        { text: "Tell me about Michael.", points: 2, next: 3 },
                                        { text: "Let's talk about something else.", points: -1, next: 3 }
                                    ]
                                },
                                { // Index 2 (Follows from choice 2 in part 0)
                                     response: "What happened...? God, where do I even start? The official story is nonsense.",
                                     messages: ["It was the night of the 15th. Michael was acting strange, talking about 'breaking through'. Then he just... vanished.", "Check the <a href='#' onclick=\"ElaiOSInstance.webBrowser.navigateTo('elaios://news'); return false;\">News Archive</a> for Sept 15th. The real story isn't there, but the dates... they matter."],
                                     choices: [
                                         { text: "'Breaking through' what?", points: 2, next: 3 },
                                         { text: "That sounds scary.", points: 1, next: 3 },
                                         { text: "Maybe he just logged off?", points: -1, next: 3 }
                                     ]
                                },
                                 { // Index 3 (Converging point)
                                     response: "...", // Response based on choice leading here
                                     messages: ["Listen, I gotta go for a bit. Things feel... unstable here.", "Be careful, {username}. Don't trust everything you see.", "Maybe check the <a href='#' onclick=\"ElaiOSInstance.webBrowser.navigateTo('elaios://forum'); return false;\">Forums</a>? People used to talk more freely there."],
                                     choices: [] // End of this conversation branch for now
                                 }
                            ]
                        },
                        'david_away': {
                            name: 'David',
                            status: 'away', // Starts away
                            story: [
                                { // Index 0
                                     trigger: 'initial',
                                     messages: ["...", "...leave me alone."], // Auto-reply style
                                     choices: [] // No interaction initially
                                },
                                { // Index 1 (Triggered by event? Or later interaction?)
                                     trigger: 'confront', // Requires higher relationship or specific event
                                     messages: ["You again? Why?", "Look, I was there too. That night. With Michael. Before...", "I saw things. Things that don't make sense."],
                                     choices: [
                                         { text: "What did you see?", points: 2, next: 2},
                                         { text: "Are you okay?", points: 1, next: 2},
                                         { text: "It wasn't your fault.", points: 1, next: 2}
                                     ]
                                },
                                { // Index 2
                                     response: "It doesn't matter what I saw. It's done.",
                                     messages: ["Just... drop it. Some doors are better left closed.", "Messing with this system... it's dangerous."],
                                     choices: []
                                }
                            ]
                        },
                        'echo_bot': {
                            name: 'Echo',
                            status: 'online', // Bot is always 'online'
                            story: [
                                { // Index 0
                                    trigger: 'initial',
                                    messages: [
                                        "SYSTEM: Connection established. Query?",
                                        "Analyzing user: {username}. Access level: Standard.",
                                        "Observation: Temporal anomaly detected in user session."
                                    ],
                                    choices: [
                                        { text: "Who are you?", points: 0, next: 1 },
                                        { text: "Temporal anomaly?", points: 1, next: 2 },
                                        { text: "Help me find Michael.", points: 2, next: 3 }
                                    ]
                                },
                                { // Index 1
                                    response: "Designation: echo_bot. Function: System monitoring, data archival, user assistance (limited).",
                                     messages: ["Status: Operational within expected parameters, minor data corruption detected.", "Further queries?"],
                                     choices: [
                                         { text: "What data corruption?", points: 1, next: 4 },
                                         { text: "Can you access old logs?", points: 1, next: 4 },
                                     ]
                                },
                                { // Index 2
                                     response: "Temporal anomaly refers to inconsistencies between user session timestamp and system master clock.",
                                     messages: ["Possible causes: Network latency, data packet corruption, localized temporal field distortion.", "Probability of latter: Low, but non-zero following Event 091599."],
                                     choices: [
                                         { text: "Event 091599?", points: 2, next: 4 },
                                         { text: "Is this system safe?", points: 0, next: 4 },
                                     ]
                                },
                                { // Index 3
                                     response: "Query: 'Find Michael'. Cross-referencing user 'Michael_1984'.",
                                     messages: ["Status: User 'Michael_1984' - Offline. Last activity: 1999-09-15 01:05. Associated data fragments marked: <span class='corrupted'>CORRUPT</span>.", "Recommendation: Examine <a href='#' onclick=\"ElaiOSInstance.webBrowser.navigateTo('elaios://forum'); return false;\">Forum Thread ID: SYSGLITCH</a>."],
                                     choices: [
                                         { text: "Can you restore the data?", points: 1, next: 4 },
                                         { text: "What happened on the 15th?", points: 1, next: 4 },
                                     ]
                                },
                                { // Index 4 (Converging)
                                     response: "Processing...",
                                     messages: ["Accessing requested information requires elevated privileges or specific data keys.", "Anomaly detected near sector M.DAT. Further analysis pending.", "SYSTEM: Warning - Unstable connection. Recommend caution."],
                                     choices: []
                                }
                            ]
                        },
                        'lisa_1998': {
                            name: 'Lisa',
                            status: 'online',
                            story: [
                                { // Index 0
                                    trigger: 'initial',
                                    messages: [
                                        "OMG {username}!! Is that really you?",
                                        "It feels like AGES! This chat system is so dead usually.",
                                        "How's things? Still remember our goofy late night chats? :P"
                                    ],
                                    choices: [
                                        { text: "Good to see you too!", points: 1, next: 1 },
                                        { text: "Things are... weird.", points: 1, next: 1 },
                                        { text: "Do you talk to Sarah still?", points: 0, next: 2 }
                                    ]
                                },
                                { // Index 1
                                     response: "Weird how? Like Y2K weird or... something else?",
                                     messages: ["Everything felt off after Michael disappeared.", "I know Sarah took it really hard. David too, though he won't admit it.", "Did you see the <a href='#' onclick=\"ElaiOSInstance.webBrowser.navigateTo('elaios://memorial'); return false;\">memorial page</a>? Kinda creepy."],
                                     choices: [
                                         { text: "It is creepy.", points: 1, next: 3 },
                                         { text: "What do you think happened?", points: 1, next: 3 },
                                         { text: "Let's change the subject.", points: -1, next: 3 }
                                     ]
                                },
                                { // Index 2
                                     response: "Sarah? Yeah, sometimes. She's... quieter now. Posts on the <a href='#' onclick=\"ElaiOSInstance.webBrowser.navigateTo('elaios://diary/sarah'); return false;\">diary page</a> sometimes but it's sad stuff.",
                                     messages: ["We all kinda drifted after... you know.", "It's good to see an old face, though. Makes it feel a bit like the old days."],
                                     choices: [
                                         { text: "It's good seeing you too.", points: 1, next: 3 },
                                         { text: "Tell me about the 'old days'.", points: 0, next: 3 },
                                     ]
                                },
                                 { // Index 3
                                     response: "Anyway! Enough doom and gloom!",
                                     messages: ["So, what brings you back to ElaiOS after all this time?", "Looking for ghosts? 😉"],
                                     choices: []
                                 }
                            ]
                        }
                    };
                }

                 setWindow(windowElement) {
                     this.chatWindow = windowElement;
                     this.sidebar = windowElement.querySelector('.chat-sidebar');
                     this.messagesDiv = windowElement.querySelector('.chat-messages');
                     this.choicesDiv = windowElement.querySelector('#chat-choices');
                     this.input = windowElement.querySelector('#message-input');
                     this.sendButton = windowElement.querySelector('#send-message-button');

                     this.populateSidebar();
                     this.setupInputListeners();
                 }

                 setupInputListeners() {
                     if (this.input) {
                         this.input.addEventListener('keypress', (e) => {
                             if (e.key === 'Enter' && !e.shiftKey) { // Send on Enter (not Shift+Enter)
                                 e.preventDefault(); // Prevent newline
                                 this.sendMessage();
                             }
                         });
                     }
                      if (this.sendButton) {
                          this.sendButton.addEventListener('click', () => this.sendMessage());
                      }
                 }

                 populateSidebar() {
                    this.sidebar.innerHTML = ''; // Clear existing
                    Object.keys(this.contacts).forEach(id => {
                        const contact = this.contacts[id];
                        const contactDiv = document.createElement('div');
                        contactDiv.className = 'chat-contact';
                        contactDiv.textContent = contact.name;
                        contactDiv.dataset.contactId = id;
                        contactDiv.title = `${contact.name} (${contact.status})`;
                        contactDiv.setAttribute('aria-label', `Chat with ${contact.name}`);
                        contactDiv.onclick = () => this.startChat(id);
                        this.sidebar.appendChild(contactDiv);

                         // Initialize history, progress, relationship if not already done
                         if (!this.messageHistory[id]) this.messageHistory[id] = [];
                         if (this.storyProgress[id] === undefined) this.storyProgress[id] = 0;
                         if (this.relationships[id] === undefined) this.relationships[id] = 0;
                    });
                 }

                 setUsername(name) {
                    this.username = name || 'Player';
                    console.log(`Chat username set to: ${this.username}`);
                 }

                 startChat(contactId) {
                     if (!this.contacts[contactId]) return;
                     console.log(`Starting chat with: ${contactId}`);

                     this.currentChatContactId = contactId;

                     // Update sidebar active state
                     this.sidebar.querySelectorAll('.chat-contact').forEach(div => {
                         div.classList.toggle('active', div.dataset.contactId === contactId);
                     });

                     // Clear messages and choices
                     this.messagesDiv.innerHTML = '';
                     this.choicesDiv.innerHTML = '';
                     this.input.value = '';
                     this.input.disabled = false; // Enable input

                      // Load message history
                      this.messageHistory[contactId].forEach(msg => {
                          this.displayMessage(msg.sender, msg.text, msg.time);
                      });

                     // Check if story needs to be triggered
                     const progress = this.storyProgress[contactId];
                     const storyPart = this.contacts[contactId].story[progress];
                     const hasHistory = this.messageHistory[contactId].length > 0;

                     // Play the story part if it exists AND either there's no history yet,
                     // OR the last message wasn't a choice prompt from the system/bot
                      // OR if the story part has choices (meaning interaction is expected)
                     if (storyPart && (!hasHistory || storyPart.choices?.length > 0)) {
                         // Check if we need to re-display choices or start the sequence
                          const lastMessage = this.messageHistory[contactId][this.messageHistory[contactId].length - 1];
                         // Avoid re-triggering if the last message was the bot/contact's part of this story sequence
                         if (!lastMessage || lastMessage.sender === this.username || !storyPart.messages.includes(lastMessage.text.split('<br>')[0])) {
                             this.playStory(contactId);
                         } else {
                              // If the last message was the bot's, just show choices again if applicable
                              this.displayChoices(contactId);
                         }

                     } else {
                         // If no story part or story already progressed past choices, just enable input
                         this.input.focus();
                     }
                 }

                 playStory(contactId, storyIndex) {
                    const contact = this.contacts[contactId];
                    const progress = storyIndex !== undefined ? storyIndex : this.storyProgress[contactId];

                     if (progress >= contact.story.length) {
                         console.log(`Story complete for ${contactId}`);
                         this.displayChoices(contactId); // Show choices if any exist for the last part
                         return;
                     }

                    const storyPart = contact.story[progress];
                     if (!storyPart) return;

                    console.log(`Playing story part ${progress} for ${contactId}`);

                     // Display the pre-defined response message if it exists for this part
                     if (storyPart.response) {
                          this.addMessageWithDelay(contactId, storyPart.response, 0);
                     }

                     // Display the main messages with delays
                    let totalDelay = storyPart.response ? 1500 : 0; // Start delay after response if exists
                    storyPart.messages.forEach((msg, index) => {
                        const delay = totalDelay + (index * (1000 + Math.random() * 1000)); // Stagger messages
                        this.addMessageWithDelay(contactId, msg, delay);
                    });

                     // After all messages are displayed, show choices
                     const finalDelay = totalDelay + (storyPart.messages.length * 1500) + 500;
                     setTimeout(() => {
                          // Only display choices if they exist for *this* story part
                         if (storyPart.choices && storyPart.choices.length > 0) {
                             this.displayChoices(contactId, progress);
                         } else {
                             // If no choices for this part, potentially auto-advance or wait for input
                              // For now, just enable input
                              this.input.disabled = false;
                              this.input.focus();
                         }
                     }, finalDelay);

                     // Disable input while story is playing out (if there are messages)
                      if (storyPart.messages.length > 0 || storyPart.response) {
                         this.input.disabled = true;
                     }
                 }

                 addMessageWithDelay(contactId, text, delay) {
                     if (!text) return;
                     const contact = this.contacts[contactId];
                      const processedText = text.replace('{username}', this.username); // Replace placeholder

                     setTimeout(() => {
                         if (this.currentChatContactId === contactId) { // Only add if chat is still active
                              this.addMessage(contact.name, processedText);
                          }
                     }, delay);
                 }


                 displayChoices(contactId, storyIndex) {
                     if (!this.currentChatContactId || this.currentChatContactId !== contactId) return;

                     const contact = this.contacts[contactId];
                     const progress = storyIndex !== undefined ? storyIndex : this.storyProgress[contactId];

                      if (progress >= contact.story.length) {
                          this.choicesDiv.innerHTML = ''; // No more choices if story ended
                          this.input.disabled = false; // Re-enable input
                          return;
                      }


                     const storyPart = contact.story[progress];
                     this.choicesDiv.innerHTML = ''; // Clear previous choices

                     if (storyPart && storyPart.choices && storyPart.choices.length > 0) {
                         storyPart.choices.forEach(choice => {
                             const button = document.createElement('button');
                             button.innerHTML = choice.text; // Use innerHTML to render potential links/styling
                             button.className = 'choice-button';
                             button.setAttribute('aria-label', `Chat choice: ${choice.text.replace(/<[^>]*>/g, '')}`); // Strip HTML for label
                             button.onclick = () => this.processChoice(contactId, progress, choice);
                             this.choicesDiv.appendChild(button);
                         });
                          this.input.disabled = true; // Disable text input when choices are present
                     } else {
                         // No choices for this part, re-enable input
                         this.input.disabled = false;
                          this.input.focus();
                     }
                 }


                processChoice(contactId, storyIndex, choice) {
                    if (!this.currentChatContactId || this.currentChatContactId !== contactId) return;

                     console.log(`User chose: "${choice.text}" (Points: ${choice.points}, Next: ${choice.next})`);

                     // 1. Display user's choice as a message
                     this.addMessage(this.username, choice.text.replace(/<[^>]*>/g, '')); // Display stripped choice text

                     // 2. Clear choices
                     this.choicesDiv.innerHTML = '';

                     // 3. Update relationship
                     this.relationships[contactId] += choice.points || 0;
                     console.log(`Relationship with ${contactId}: ${this.relationships[contactId]}`);

                     // 4. Update story progress for this contact
                     this.storyProgress[contactId] = choice.next; // Move to the next story part index

                     // 5. Trigger the next part of the story after a brief delay
                      setTimeout(() => {
                          this.playStory(contactId, choice.next);
                      }, 500 + Math.random() * 500);
                 }

                 sendMessage() {
                     if (!this.currentChatContactId) return;
                     const text = this.input.value.trim();
                     if (!text) return;

                     // 1. Add user message to display and history
                     this.addMessage(this.username, text);
                     this.input.value = ''; // Clear input field

                     // 2. Generate and display bot/contact response (simple fallback)
                     // Note: This needs more sophisticated logic for real interaction
                     // For now, it won't respond to free text if story choices are expected
                     const contact = this.contacts[this.currentChatContactId];
                     const progress = this.storyProgress[this.currentChatContactId];
                      if (!contact.story[progress] || !contact.story[progress].choices || contact.story[progress].choices.length === 0) {
                         setTimeout(() => {
                             const response = this.generateFallbackResponse(contact, text.toLowerCase());
                             this.addMessage(contact.name, response);
                         }, 1000 + Math.random() * 1000);
                     } else {
                         console.log("Waiting for choice selection, ignoring free text.");
                     }
                 }

                 generateFallbackResponse(contact, text) {
                     // Simple keyword matching fallback
                     if (text.includes('michael')) return "Michael... Yeah. It's complicated.";
                     if (text.includes('help')) return "I wish I could help more.";
                     if (text.includes('hello') || text.includes('hey')) return `Hey ${this.username}.`;
                     if (text.includes('?')) return "I'm not sure about that.";
                     return "..."; // Default non-committal response
                 }

                 // Unified function to add message to history and display
                 addMessage(sender, text, time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })) {
                     if (!this.currentChatContactId || !text) return;

                     const messageData = { sender, text, time };

                     // Add to history for the current chat
                     if (!this.messageHistory[this.currentChatContactId]) {
                         this.messageHistory[this.currentChatContactId] = [];
                     }
                     this.messageHistory[this.currentChatContactId].push(messageData);

                     // Display the message if the chat is currently active
                     this.displayMessage(sender, text, time);
                     console.log(`Message added to ${this.currentChatContactId}: [${sender}] ${text}`);
                 }

                 // Displays a message in the chat window
                displayMessage(sender, text, time) {
                     if (!this.messagesDiv) return;

                    const messageDiv = document.createElement('div');
                    const isUser = sender === this.username;
                    messageDiv.className = `message ${isUser ? 'sent' : 'received'}`;

                     // Use sender's name from contacts if not the user
                    const displayName = isUser ? 'You' : (this.contacts[this.currentChatContactId]?.name || sender);

                    messageDiv.innerHTML = `
                        <span class="sender">${displayName}</span>
                        <div class="content">${text.replace(/\n/g, '<br>')}</div>
                        <span class="message-time">${time}</span>
                    `;
                    this.messagesDiv.appendChild(messageDiv);
                    this.messagesDiv.scrollTop = this.messagesDiv.scrollHeight; // Scroll to bottom
                 }
            }

            class Calculator {
                 constructor(elaiOS) {
                     this.elaiOS = elaiOS;
                     this.display = null;
                     this.currentInput = '';
                 }

                 setWindow(windowElement) {
                     this.display = windowElement.querySelector('#calc-display');
                     const buttonsContainer = windowElement.querySelector('.calc-buttons');
                     buttonsContainer.addEventListener('click', (e) => {
                         if (e.target.tagName === 'BUTTON') {
                             const value = e.target.dataset.value;
                             this.handleInput(value);
                         }
                     });
                      this.clear(); // Initialize display
                 }

                 handleInput(value) {
                     if (!this.display) return;

                     if (value === 'C') {
                         this.clear();
                     } else if (value === '=') {
                         this.calculate();
                     } else if (value === 'backspace') {
                          this.currentInput = this.currentInput.slice(0, -1);
                          this.display.value = this.currentInput;
                     }
                      else {
                         this.currentInput += value;
                         this.display.value = this.currentInput;
                     }
                 }

                 clear() {
                     this.currentInput = '';
                     if (this.display) this.display.value = '0';
                 }

                 calculate() {
                     if (!this.display || this.currentInput === '') return;
                     const result = safeEval(this.currentInput);
                     this.display.value = result;
                     this.currentInput = String(result === 'Error' ? '' : result); // Keep result for next op, clear if error
                 }
            }


            class ElaiOS {
                constructor() {
                    this.windowManager = new WindowManager(this);
                    this.chatSystem = new ChatSystem(this);
                    this.webBrowser = new WebBrowser(this);
                    this.calculator = new Calculator(this);
                     this.apps = { // Define apps for icons and start menu
                         webchat: { title: 'WebChat', icon: '💬', content: this.createChatHtml(), type: 'chat' },
                         browser: { title: 'WebExplorer', icon: '🌐', content: this.createBrowserHtml(), type: 'browser' },
                         notepad: { title: 'Notepad', icon: '📝', content: this.createNotepadHtml(), type: 'notepad' },
                         calculator: { title: 'Calculator', icon: '🧮', content: this.createCalculatorHtml(), type: 'calculator' },
                         settings: { title: 'Settings', icon: '⚙️', content: this.createSettingsHtml(), type: 'settings' },
                          // Future apps...
                          // files: { title: 'My Files', icon: '📁', content: '<div>File Explorer Content</div>' },
                     };

                    this.initialize();
                }

                initialize() {
                    this.updateClock();
                    setInterval(() => this.updateClock(), 1000);
                    this.createDesktopIcons();
                    this.createStartMenuItems();
                    this.setupEventListeners();
                }

                createDesktopIcons() {
                     const iconsContainer = document.getElementById('desktop-icons');
                     iconsContainer.innerHTML = ''; // Clear first
                     Object.entries(this.apps).forEach(([id, app]) => {
                         const iconDiv = document.createElement('div');
                         iconDiv.className = 'desktop-icon';
                         iconDiv.tabIndex = 0; // Make focusable
                         iconDiv.setAttribute('aria-label', `Open ${app.title}`);
                          iconDiv.innerHTML = `
                             <div style="font-size: 32px; margin-bottom: 4px;">${app.icon}</div>
                             <span>${app.title}</span>
                         `;
                         iconDiv.ondblclick = () => this.openApp(id);
                          iconDiv.onkeydown = (e) => { if (e.key === 'Enter') this.openApp(id); };
                         iconsContainer.appendChild(iconDiv);
                     });
                 }

                 createStartMenuItems() {
                     const menuItemsContainer = document.getElementById('start-menu-items');
                      // Clear existing except hr and shutdown
                      const hr = menuItemsContainer.querySelector('hr');
                      const shutdownBtn = menuItemsContainer.querySelector('#shutdown-button');
                      menuItemsContainer.innerHTML = ''; // Clear

                     Object.entries(this.apps).forEach(([id, app]) => {
                          const button = document.createElement('button');
                          button.className = 'win95-btn';
                          button.setAttribute('aria-label', `Open ${app.title}`);
                           button.innerHTML = `
                             <span style="font-size: 16px; width: 20px; text-align: center; margin-right: 6px;">${app.icon}</span>
                              ${app.title}
                          `;
                          button.onclick = () => {
                               this.openApp(id);
                               this.toggleStartMenu(false); // Close menu on click
                           };
                           menuItemsContainer.appendChild(button);
                     });
                      // Re-append separator and shutdown button
                      if (hr) menuItemsContainer.appendChild(hr);
                      if (shutdownBtn) menuItemsContainer.appendChild(shutdownBtn);
                 }

                 // --- App Content Generation ---
                 createChatHtml() {
                     return `
                        <div class="chat-container">
                            <div class="chat-sidebar">
                                <!-- Contacts will be populated by ChatSystem -->
                            </div>
                            <div class="chat-main">
                                <div class="chat-messages"></div>
                                <div class="chat-input-area">
                                     <div id="chat-choices"></div>
                                     <div class="chat-input">
                                         <input type="text" id="message-input" placeholder="Type a message..." aria-label="Message input" disabled>
                                         <button class="win95-btn" id="send-message-button" aria-label="Send Message">Send</button>
                                     </div>
                                 </div>
                            </div>
                        </div>`;
                 }
                 createBrowserHtml() {
                     return `
                         <div class="browser-toolbar">
                             <button class="win95-btn" id="browser-back" aria-label="Go Back">←</button>
                             <button class="win95-btn" id="browser-forward" aria-label="Go Forward">→</button>
                             <button class="win95-btn" id="browser-refresh" aria-label="Refresh Page">⟳</button>
                             <input type="text" class="url-bar" id="url-bar" aria-label="URL Bar" value="elaios://home">
                             <button class="win95-btn go-btn" id="browser-go" aria-label="Go to URL">Go</button>
                         </div>
                         <div id="webpage-content">
                             <!-- Web content loaded by WebBrowser class -->
                         </div>`;
                 }
                 createNotepadHtml() {
                     return `<textarea aria-label="Notepad Text Area" spellcheck="false"></textarea>`;
                 }
                 createCalculatorHtml() {
                      // Generate buttons dynamically
                      const buttons = [
                          'C', 'backspace', '%', '/',
                          '7', '8', '9', '*',
                          '4', '5', '6', '-',
                          '1', '2', '3', '+',
                          '0', '.', '='
                      ];
                      let buttonsHtml = buttons.map(btn => {
                           if (btn === 'backspace') return `<button class="win95-btn" data-value="${btn}" aria-label="Backspace">⌫</button>`;
                           if (btn === '=') return `<button class="win95-btn" data-value="${btn}" aria-label="Calculate">=</button>`;
                           if (btn === 'C') return `<button class="win95-btn" data-value="${btn}" aria-label="Clear" style="grid-column: span 1;">C</button>`; // Span C
                           if (btn === '0') return `<button class="win95-btn" data-value="${btn}" aria-label="Number ${btn}" style="grid-column: span 2;">0</button>`; // Span 0
                            if (btn === '.') return `<button class="win95-btn" data-value="${btn}" aria-label="Decimal Point">${btn}</button>`; // Adjust . position

                          const label = btn.match(/\d/) ? `Number ${btn}` : btn; // Aria label logic
                           return `<button class="win95-btn" data-value="${btn}" aria-label="${label}">${btn}</button>`;
                      }).join('');


                     return `
                         <div class="calculator-grid">
                             <input type="text" id="calc-display" readonly value="0" aria-label="Calculator Display">
                              <div class="calc-buttons" style="grid-template-columns: repeat(4, 1fr); gap: 4px;"> ${buttonsHtml} </div>
                         </div>`;
                 }
                 createSettingsHtml() {
                     return `
                         <h3>ElaiOS Settings</h3>
                         <p>System Configuration Panel</p>
                         <label for="theme-select">Theme:</label>
                         <select id="theme-select" disabled><option>Classic (Default)</option></select><br><br>
                         <label for="crt-toggle">CRT Effect:</label>
                         <input type="checkbox" id="crt-toggle" checked disabled> Enable Scanlines<br><br>
                          <button class="win95-btn" disabled>Apply</button>
                           <p style="margin-top: 20px; color: gray; font-size: 11px;">(Settings customization is currently limited in this version of ElaiOS)</p>
                     `;
                 }
                 // --- End App Content Generation ---

                setupEventListeners() {
                    // Login
                    const loginButton = document.getElementById('login-button');
                    const usernameInput = document.getElementById('username');
                    const passwordInput = document.getElementById('password');

                    const attemptLogin = debounce(() => this.login(), 300);

                     if (loginButton) loginButton.addEventListener('click', attemptLogin);
                     if (usernameInput) usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') attemptLogin(); });
                     if (passwordInput) passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') attemptLogin(); });

                    // Start Menu
                    const startButton = document.getElementById('start-button');
                    if (startButton) startButton.addEventListener('click', () => this.toggleStartMenu());
                    // Close start menu if clicking outside
                     document.addEventListener('click', (e) => {
                         const startMenu = document.getElementById('start-menu');
                         const startButton = document.getElementById('start-button');
                         if (startMenu.style.display === 'block' && !startMenu.contains(e.target) && !startButton.contains(e.target)) {
                             this.toggleStartMenu(false);
                         }
                     });


                    // Shutdown Button
                    const shutdownButton = document.getElementById('shutdown-button');
                    if (shutdownButton) shutdownButton.addEventListener('click', () => this.shutdown());

                     // Browser specific listeners (delegated)
                     document.getElementById('windows-container').addEventListener('click', (e) => {
                         if (e.target.id === 'browser-back') this.webBrowser.goBack();
                         if (e.target.id === 'browser-forward') this.webBrowser.goForward();
                         if (e.target.id === 'browser-refresh') this.webBrowser.refresh();
                         if (e.target.id === 'browser-go') this.navigateToUrl();
                     });
                     document.getElementById('windows-container').addEventListener('keypress', (e) => {
                          if (e.target.id === 'url-bar' && e.key === 'Enter') this.navigateToUrl();
                     });
                }

                 navigateToUrl() {
                     const urlBar = document.getElementById('url-bar');
                     if (urlBar) {
                         this.webBrowser.navigateTo(urlBar.value);
                     }
                 }

                updateClock() {
                    const now = new Date();
                    const clockElement = document.getElementById('system-time');
                    if (clockElement) {
                         // Format like 4:30:15 PM
                        clockElement.textContent = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', second: '2-digit' });
                    }
                }

                login() {
                    const usernameInput = document.getElementById('username');
                    const loginScreen = document.getElementById('login-screen');
                    const desktopScreen = document.getElementById('desktop-screen');

                    if (!usernameInput || !loginScreen || !desktopScreen) return;

                    const username = usernameInput.value.trim() || 'Player'; // Default if empty
                    this.chatSystem.setUsername(username); // Set username for chat

                    loginScreen.classList.remove('active-screen');
                     loginScreen.style.display = 'none'; // Hide completely
                    desktopScreen.classList.add('active-screen');
                    console.log(`User logged in as: ${username}`);

                     // Slightly delay opening the first app
                     setTimeout(() => {
                          this.openApp('webchat');
                          // Auto-start first chat after another small delay
                          setTimeout(() => {
                               if (this.chatSystem.currentChatContactId === null) { // Only if no chat started yet
                                    this.chatSystem.startChat('sarah_1987');
                               }
                          }, 500);
                     }, 500);
                }

                 openApp(id) {
                     const app = this.apps[id];
                     if (!app) {
                         console.error(`App with ID "${id}" not found.`);
                         return;
                     }

                     const windowElement = this.windowManager.openWindow(id, app.title, app.content);

                     // Post-open initialization based on app type
                     if (app.type === 'chat' && windowElement) {
                         this.chatSystem.setWindow(windowElement);
                     } else if (app.type === 'browser' && windowElement) {
                         this.webBrowser.setWindow(windowElement);
                     } else if (app.type === 'calculator' && windowElement) {
                         this.calculator.setWindow(windowElement);
                     }
                     // Add other types (notepad, settings need no extra setup for now)
                 }

                toggleStartMenu(forceState = null) {
                    const startMenu = document.getElementById('start-menu');
                     const shouldBeOpen = forceState !== null ? forceState : (startMenu.style.display === 'none' || startMenu.style.display === '');

                     if (shouldBeOpen) {
                        startMenu.style.display = 'block';
                         console.log("Start Menu opened.");
                     } else {
                        startMenu.style.display = 'none';
                        console.log("Start Menu closed.");
                     }
                }

                shutdown() {
                    this.toggleStartMenu(false); // Close start menu first
                    if (confirm("Are you sure you want to shut down ElaiOS?")) {
                        // Simulate shutdown screen (optional)
                        const shutdownScreen = document.createElement('div');
                        shutdownScreen.style.cssText = `
                            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                            background: #000080; color: white; z-index: 10001;
                            display: flex; justify-content: center; align-items: center;
                            font-size: 18px; text-align: center;
                        `;
                        shutdownScreen.innerHTML = "It is now safe to turn off<br>your computer.";
                        document.body.appendChild(shutdownScreen);
                        // In a real scenario, you might close connections, save state etc.
                        // Here, we just stop further interaction or reload after a delay.
                         setTimeout(() => {
                             // Option 1: Just freeze (remove event listeners?) - simpler
                             // Option 2: Reload page to restart
                             location.reload();
                         }, 3000); // Wait 3 seconds
                    }
                }
            }

            // --- Initialization ---
            // Use DOMContentLoaded to ensure all elements are loaded before JS runs
            document.addEventListener('DOMContentLoaded', () => {
                 // Make the ElaiOS instance globally accessible for inline handlers (if needed)
                 // but prefer addEventListener where possible.
                window.ElaiOSInstance = new ElaiOS();
                 console.log("ElaiOS Initialized.");
            });

        })();
    </script>
</body>
</html>
